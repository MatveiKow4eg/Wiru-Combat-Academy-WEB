ПРОМПТ ДЛЯ IDE (копируй полностью):

Хочу добавить в проект Flask полноценную систему ролей с уровнями доступа. Сделай всё ПОШАГОВО, не переписывая весь проект сразу. На каждом шаге:

Объясняй, что именно ты делаешь и зачем.

Показывай только нужные изменения конкретных файлов.

Жди моего подтверждения перед переходом к следующему шагу.

Задача:
Добавить роль superadmin, которая будет доступна только моему основному аккаунту.
Только супер-админ может назначать и снимать админов через сайт.
Админы могут пользоваться админкой, но НЕ могут делать других админами.
Обычные пользователи не имеют доступа к админке.

Требуемый функционал:
ШАГ 1 — Обновление модели User

Добавить в таблицу user новое поле is_superadmin = db.Column(db.Boolean, default=False).

Роль хранится в role, и возможные значения теперь: "user", "admin", "superadmin".

В User добавить удобные свойства:

is_admin возвращает True, если role == "admin" или is_superadmin == True.

is_superadmin как отдельное булево поле.

Спросить у меня, после вывода, можно ли переходить к шагу 2.

ШАГ 2 — Обновление seed_if_empty()

Найти существующую функцию сидирования (инициализации админа).

Исправить так, чтобы:

Если в БД уже есть is_superadmin == True, ничего не делать.

Если супер-админа нет — создать супер-админа с email, который я скажу (спроси у меня).

У супер-админа роль "superadmin" и is_superadmin=True.

Убрать генерацию случайного пароля при каждом старте — пароль должен приходить из ENV (ADMIN_PASSWORD).

Дождаться моего подтверждения перед шагом 3.

ШАГ 3 — Декораторы доступа

Создать два декоратора:

@admin_required — разрешает доступ только:

admin

superadmin

@superadmin_required — доступ только супер-админу.

Обновить существующие декораторы, если нужно, но не ломать текущую структуру.

Показать изменения и спросить, можно ли переходить к шагу 4.

ШАГ 4 — Маршруты управления администраторами

В модуле admin (где у меня routes /admin/users):

Добавить два POST-маршрута:

POST /admin/users/<id>/make-admin

доступ только superadmin

меняет role='admin', is_admin=True

POST /admin/users/<id>/remove-admin

доступ только superadmin

меняет role='user', is_admin=False

При попытке изменить супер-админа → возвращать flash-сообщение с ошибкой.

Спросить перед переходом к шагу 5.

ШАГ 5 — Доработка шаблонов

В templates/admin/user_detail.html:

Если current_user.is_superadmin == True → показывать кнопки:

“Сделать админом”

“Снять админа”

Если текущий user является superadmin → не показывать кнопки.

Если обычный admin заходит в профиль → кнопок тоже не должно быть.

После показа diff-ов всех шаблонов — спросить, можно ли идти дальше.

ШАГ 6 — Проверка всего функционала

Сделать список того, что должно работать:

супер-админ видит кнопки управления ролями;

обычный админ их не видит;

обычный пользователь не попадает в админку;

супер-админ не может снять роль сам с себя;

обновление роли сразу отражается после обновления страницы.

После проверки вывести сводку изменений.

ВАЖНОЕ ПРАВИЛО

Ты не переписываешь весь файл полностью.

Ты даёшь только точечные изменения и объяснения.

Ждёшь подтверждения пользователя после каждого шага.