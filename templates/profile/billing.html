{% extends 'base.html' %}
{% block title %}{{ _('–ê–±–æ–Ω–µ–º–µ–Ω—Ç –∏ –æ–ø–ª–∞—Ç—ã') }} ‚Äî Wiru Combat Academy{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<style>
  .actions-center{ text-align:center; margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  .btn-secondary{ background:#1b1b1b; border:1px solid #303030; color:#ddd; }
  .btn-secondary:hover{ border-color: var(--accent); color:#fff; }
  .state-active{ color:#00d084; font-weight:600; }
  .state-expired{ color:#f0c04a; font-weight:600; }
  .state-none{ color:#aaa; }
  .bill-empty{ text-align:center; padding:12px 6px; }
  .bill-empty .icon{ font-size:42px; opacity:.8; margin-bottom:4px; }
    .plans{ margin-top:16px; }
  .plans .btn{ min-width: 220px; }
  .table-row:hover{ background:#171717; }
  @media (max-width: 768px){
    .actions-center .btn{ width:100%; }
    .plans .btn{ width:100%; }
  }
</style>
{% endblock %}
{% block content %}
<div class="profile-layout">
  {% set active_tab = 'billing' %}
  {% include 'profile/_profile_nav.html' %}

  <section class="content">
    <div class="card">
      <div class="card-head"><h2>{{ _('–¢–µ–∫—É—â–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç') }}</h2></div>
      <div class="card-body">
        {% set sub = active_sub %}
        {% set has_sub = sub is not none %}
        {% set is_active = has_sub and (sub.status == 'active' or (sub.current_period_end and sub.current_period_end > now)) %}
        {% set is_expired = has_sub and not is_active %}

        {% if not has_sub %}
          <div class="bill-empty">
            <div class="icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
            <p class="muted">{{ _('–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞.') }}</p>
            <div class="actions-center">
              <a class="btn btn-accent" href="#plans">{{ _('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã') }}</a>
              <a class="btn btn-secondary" href="#payments">{{ _('–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç') }}</a>
            </div>
                      </div>
        {% elif is_active %}
          {% set plan_type = '–ú–µ—Å—è—á–Ω—ã–π' if sub.stripe_price_id == config.STRIPE_PRICE_MONTHLY else ('–ì–æ–¥–æ–≤–æ–π' if sub.stripe_price_id == config.STRIPE_PRICE_YEARLY else '‚Äî') %}
          <div class="info-grid">
            <div>
              <label>{{ _('–¢–∏–ø') }}</label>
              <div class="value">{{ plan_type }}</div>
            </div>
            <div>
              <label>{{ _('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞') }}</label>
              <div class="value">{{ (sub.created_at or now).strftime('%d.%m.%Y') }}</div>
            </div>
            <div>
              <label>{{ _('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è') }}</label>
              <div class="value">{{ sub.current_period_end.strftime('%d.%m.%Y') if sub.current_period_end else '‚Äî' }}</div>
            </div>
            <div>
              <label>{{ _('–°—Ç–∞—Ç—É—Å') }}</label>
              <div class="value state-active">{{ _('–∞–∫—Ç–∏–≤–Ω–∞') }} ‚úÖ</div>
            </div>
          </div>
          <div class="actions-center">
            <button class="btn btn-accent" onclick="createCheckout('{{ config.STRIPE_PRICE_MONTHLY }}')">{{ _('–ü—Ä–æ–¥–ª–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç') }}</button>
            <a class="btn btn-secondary" href="#plans">{{ _('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã') }}</a>
          </div>
        {% elif is_expired %}
          {% if sub.current_period_end %}
            {% set days_past = ((now.timestamp() - sub.current_period_end.timestamp()) // 86400)|int %}
          {% else %}
            {% set days_past = None %}
          {% endif %}
          <p class="muted">
            {% if days_past is not none and days_past > 0 %}
              {{ _('–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞') }} {{ days_past }} {{ _('–¥–Ω. –Ω–∞–∑–∞–¥.') }}
            {% else %}
              {{ _('–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.') }}
            {% endif %}
          </p>
          <div class="actions-center">
            <button class="btn btn-accent" onclick="createCheckout('{{ config.STRIPE_PRICE_MONTHLY }}')">{{ _('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–Ω–æ–≤–æ') }}</button>
            <a class="btn btn-secondary" href="#plans">{{ _('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞—Ä–∏—Ñ—ã') }}</a>
          </div>
        {% endif %}

        <div class="plans" id="plans">
          <div class="actions-center">
            <button class="btn btn-accent" onclick="createCheckout('{{ config.STRIPE_PRICE_MONTHLY }}')">{{ _('–ö—É–ø–∏—Ç—å –º–µ—Å—è—á–Ω—ã–π') }}</button>
            <button class="btn btn-secondary" onclick="createCheckout('{{ config.STRIPE_PRICE_YEARLY }}')">{{ _('–ö—É–ø–∏—Ç—å –≥–æ–¥–æ–≤–æ–π') }}</button>
            {% if customer_id %}
              <button class="btn btn-secondary" onclick="openPortal()">{{ _('–£–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–æ–π') }}</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="payments">
      <div class="card-head"><h2>{{ _('–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç') }}</h2></div>
      <div class="card-body">
        <div class="table">
          <div class="table-row head">
            <div>{{ _('–î–∞—Ç–∞') }}</div>
            <div>{{ _('–°—É–º–º–∞') }}</div>
            <div>{{ _('–°—Ç–∞—Ç—É—Å') }}</div>
            <div>{{ _('Invoice') }}</div>
          </div>
          {% for p in payments %}
          <div class="table-row">
            <div>{{ (p.paid_at or p.created_at).strftime('%d.%m.%Y %H:%M') }}</div>
            <div>{{ (p.amount or 0)/100 }} {{ p.currency or 'EUR' }}</div>
            <div><span class="chip status-{{ p.status }}">{{ p.status }}</span></div>
            <div>
              {% if p.stripe_invoice_id %}
                <a href="https://invoice.stripe.com/i/{{ p.stripe_invoice_id }}" target="_blank" rel="noopener">{{ p.stripe_invoice_id }}</a>
              {% else %} ‚Äî {% endif %}
            </div>
          </div>
          {% else %}
            <div class="table-row"><div class="muted">{{ _('–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ –æ–ø–ª–∞—Ç.') }}</div></div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>
</div>

<script>
async function createCheckout(price_id){
  const resp = await fetch('/billing/checkout/session', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({price_id})});
  const data = await resp.json();
  if (data.url) window.location = data.url; else alert('{{ _('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –æ–ø–ª–∞—Ç—ã') }}');
}
async function openPortal(){
  const resp = await fetch('/billing/portal', {method:'POST'});
  const data = await resp.json();
  if (data.url) window.location = data.url; else alert('{{ _('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–∞–ª–∞') }}');
}
</script>
{% endblock %}
