{% extends "base.html" %}
{% block title %}{{ _('РАСПИСАНИЕ') }}{% endblock %}
{% block extra_css %}
<style>
  .cards.two{ grid-template-columns: 1fr; }
  .actions-center{ text-align:center; margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  .actions-center .btn{ min-width:220px; }
  /* Schedule readable grid */
  .schedule-grid{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px; }
  @media (max-width: 900px){ .schedule-grid{ grid-template-columns: 1fr; } }
  .day-card{ border:1px solid var(--border); border-radius:12px; background:#141414; overflow:hidden; transition: transform .18s ease, box-shadow .18s ease; }
  .day-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); color:#fff; font-weight:700; }
  .day-code{ font-size:20px; letter-spacing:.5px; }
  .day-full{ color:#aaa; font-size:12px; margin-left:8px; font-weight:500; }
  .today-chip{ background:#103a27; color:#00d084; border:1px solid #0a3; padding:2px 8px; border-radius:999px; font-size:12px; }
  .slots{ display:grid; gap:8px; padding:10px 12px; }
  .slot{ display:grid; grid-template-columns: auto 1fr auto auto; gap:10px; align-items:center; padding:8px 10px; border:1px solid #222; border-radius:12px; background:#131313; }
  .slot:hover{ background:#161616; }
  .time-badge{ background:#1e1e1e; border:1px solid #2f2f2f; color:#fff; border-radius:6px; padding:4px 8px; font-weight:600; min-width:64px; text-align:center; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; }
  .activity{ color:#fff; font-weight:500; }
  .coach-muted{ color:#aaa; font-size:14px; }
  .badge-age{ background:#1b1b1b; border:1px solid #2a2a2a; color:#bbb; border-radius:999px; padding:2px 8px; font-size:12px; white-space:nowrap; }
/* Plans (subscriptions) */
  .plans-section{ margin-top: 2.5rem; }
  .plans-header{ text-align:left; margin-bottom: 1.5rem; }
  .plans-title{ color: var(--head); font-size: clamp(32px, 6vw, 64px); font-weight:700; margin: 0 0 .5rem; }
  .plans-subtitle{ color: var(--muted); margin-top: .5rem; }

  .plans-grid{ display:grid; grid-template-columns: 1fr; gap: 20px; }
  @media (min-width: 640px){ .plans-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (min-width: 1024px){ .plans-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

  .plan-card{ background: var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow: 0 6px 20px rgba(0,0,0,.25); display:flex; flex-direction:column; padding: 1.25rem; transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease; min-height:100%; }
  .plan-card:hover{ transform: translateY(-3px); box-shadow: 0 14px 32px rgba(0,0,0,.35); }
  .plan-card.featured{ border-color: var(--accent); box-shadow: 0 0 0 1px rgba(224,37,37,.5), 0 12px 28px rgba(224,37,37,.15); }

  .plan-badge{ align-self:flex-start; background: rgba(224,37,37,.1); color: var(--accent); border:1px solid var(--accent); padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight:600; margin-bottom:.5rem; }

  .plan-head{ margin-bottom:.75rem; }
  .plan-name{ color: var(--text); font-size: 1.25rem; font-weight:700; margin:0; }
  .plan-desc{ color: var(--muted); margin-top:.25rem; font-size:.95rem; }

  .plan-price{ color: var(--text); font-size: 2rem; font-weight:800; margin:.75rem 0 0; display:flex; align-items: baseline; gap:.5rem; }
  .plan-period{ color: var(--muted); font-size:.9rem; }
  .plan-price-note{ color: var(--muted); font-size:.8rem; margin-top:.25rem; }

  .plan-features{ list-style:none; padding:0; margin:1rem 0; display:grid; gap:.5rem; }
  .plan-feature{ display:flex; align-items:flex-start; gap:.5rem; color: var(--text); }
  .plan-feature svg{ flex:0 0 auto; width:18px; height:18px; color:#44c767; }
  .plan-feature span{ flex:1 1 auto; }

  .plan-cta{ margin-top:auto; display:flex; gap:.5rem; align-items:center; }
  .plan-cta .btn{ width:100%; }

  .btn-accent{ background: var(--accent); border-color: var(--accent); color:#fff; }
  .btn-accent:hover{ background: var(--accent-hover); border-color: var(--accent-hover); }
  .btn-outline{ background: transparent; border:1px solid var(--border); color: var(--text); }
  .btn-outline:hover{ border-color: var(--accent); }

  .btn:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  .btn[disabled]{ opacity:.7; cursor:not-allowed; }

  /* Tabs */
  .plans-tabs{ display:flex; gap:1rem; border-bottom:1px solid var(--border); margin: 1rem 0 1.25rem; overflow:auto; }
  .plans-tab{ appearance:none; background:transparent; border:0; color: var(--text); padding:.75rem 1rem; cursor:pointer; font-weight:600; border-bottom:2px solid transparent; }
  .plans-tab[aria-selected="true"]{ color: var(--accent); border-bottom-color: var(--accent); }
  .plans-tab:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  .plans-panels{}
  .plans-panel[hidden]{ display:none; }
  .plans-footnote{ color: var(--muted); font-size:.85rem; margin-top:1rem; text-align:center; }
</style>
{% endblock %}
{% block content %}
<section class="container pad-y">
  <h1>{{ _('Расписание тренировок') }}</h1>
  <div class="cards two">
    <div class="card">
            <div class="card-body">
        {% set lang = session.get('lang', 'ru') %}
        {% if lang == 'en' %}
          {% set days = [
            {'code':'Mon','full':'Monday'},
            {'code':'Tue','full':'Tuesday'},
            {'code':'Wed','full':'Wednesday'},
            {'code':'Thu','full':'Thursday'},
            {'code':'Fri','full':'Friday'},
            {'code':'Sat','full':'Saturday'},
            {'code':'Sun','full':'Sunday'}
          ] %}
        {% elif lang == 'et' %}
          {% set days = [
            {'code':'E','full':'Esmaspäev'},
            {'code':'T','full':'Teisipäev'},
            {'code':'K','full':'Kolmapäev'},
            {'code':'N','full':'Neljapäev'},
            {'code':'R','full':'Reede'},
            {'code':'L','full':'Laupäev'},
            {'code':'P','full':'Pühapäev'}
          ] %}
        {% else %}
          {% set days = [
            {'code':'Пн','full':'Понедельник'},
            {'code':'Вт','full':'Вторник'},
            {'code':'Ср','full':'Среда'},
            {'code':'Чт','full':'Четверг'},
            {'code':'Пт','full':'Пятница'},
            {'code':'Сб','full':'Суббота'},
            {'code':'Вс','full':'Воскресенье'}
          ] %}
        {% endif %}

        {% set base_codes = ['E','T','K','N','R','L','P'] %}
        <div class="schedule-grid">
          {% for d in days %}
            {% set idx = loop.index0 %}
            {% set items = (schedule | selectattr('day_of_week', 'equalto', idx) | list) | sort(attribute='time') %}
            <div class="day-card">
              <div class="day-head">
                <div>
                  <span class="day-code">{{ d.code }}</span>
                  <span class="day-full">{{ d.full }}</span>
                </div>
                <span class="today-chip" data-day="{{ base_codes[idx] }}" hidden>{{ _('Сегодня') }}</span>
              </div>
              <div class="slots">
                {% if items and items|length > 0 %}
                  {% for it in items %}
                    <div class="slot">
                      <span class="time-badge">{{ it.time }}</span>
                      <span class="activity">
                        {% if it.discipline == 'other' %}
                          {{ it.activity }}
                        {% else %}
                          {% if it.discipline == 'boxing' %}{{ _('Бокс') }}{% elif it.discipline == 'wrestling' %}{{ _('Борьба') }}{% elif it.discipline == 'mma' %}{{ _('ММА') }}{% else %}{{ it.activity }}{% endif %}{% if it.age %} <span class="age-display" data-age="{{ it.age }}">{{ it.age }}</span>{% endif %}
                        {% endif %}
                      </span>
                      <span></span>
                      <span class="coach-muted">{{ it.coach or '' }}</span>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="slot">
                    <span class="time-badge">—</span>
                    <span class="coach-muted">{{ _('Нет занятий') }}</span>
                    <span></span>
                    <span></span>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    </div>
</section>

{# Блок абонементов временно отключён #}
{#
<section class="container pad-y plans-section" aria-labelledby="plans-title">
  <header class="plans-header">
#}
{#
    <h1 id="plans-title" class="plans-title">{{ _('Абонементы') }}</h1>
    <p class="plans-subtitle">{{ _('Выбери формат и дисциплину, которая подходит твоим целям.') }}</p>
  </header>

  <nav class="plans-tabs" role="tablist" aria-label="{{ _('Абонементы') }}">
    <button class="plans-tab" role="tab" id="tab-boxing" data-key="boxing" aria-controls="panel-boxing" aria-selected="false">{{ _('plans.tabs.boxing') }}</button>
    <button class="plans-tab" role="tab" id="tab-wrestling" data-key="wrestling" aria-controls="panel-wrestling" aria-selected="false">{{ _('plans.tabs.wrestling') }}</button>
    <button class="plans-tab" role="tab" id="tab-mma" data-key="mma" aria-controls="panel-mma" aria-selected="false">{{ _('plans.tabs.mma') }}</button>
    <button class="plans-tab" role="tab" id="tab-all" data-key="all" aria-controls="panel-all" aria-selected="false">{{ _('plans.tabs.all') }}</button>
  </nav>

  {% if not plans_by_discipline is defined %}
    {% set pbd = {
      'boxing': [
        { 'id':'bx_1m', 'price_eur':45, 'period_label':'plans.period.month', 'features':['plans.feature.boxing.all','plans.feature.boxing.kids_teen','plans.feature.guest_1'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=bx_1m' },
        { 'id':'bx_3m', 'price_eur':120, 'period_label':'plans.period.period', 'features':['plans.feature.save_10','plans.feature.priority','plans.feature.freeze_7'], 'is_featured': true, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=bx_3m' },
        { 'id':'bx_12m', 'price_eur':420, 'period_label':'plans.period.period', 'features':['plans.feature.best_price','plans.feature.merch_10','plans.feature.freeze_14'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=bx_12m' }
      ],
      'wrestling': [
        { 'id':'wr_1m', 'price_eur':45, 'period_label':'plans.period.month', 'features':['plans.feature.wrestling.all','plans.feature.unlimited','plans.feature.guest_1'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=wr_1m' },
        { 'id':'wr_3m', 'price_eur':120, 'period_label':'plans.period.period', 'features':['plans.feature.save_10','plans.feature.priority','plans.feature.freeze_7'], 'is_featured': true, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=wr_3m' },
        { 'id':'wr_12m', 'price_eur':420, 'period_label':'plans.period.period', 'features':['plans.feature.best_price','plans.feature.merch_10','plans.feature.freeze_14'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=wr_12m' }
      ],
      'mma': [
        { 'id':'mma_1m', 'price_eur':45, 'period_label':'plans.period.month', 'features':['plans.feature.mma.all','plans.feature.unlimited','plans.feature.guest_1'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=mma_1m' },
        { 'id':'mma_3m', 'price_eur':120, 'period_label':'plans.period.period', 'features':['plans.feature.save_10','plans.feature.priority','plans.feature.freeze_7'], 'is_featured': true, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=mma_3m' },
        { 'id':'mma_12m', 'price_eur':420, 'period_label':'plans.period.period', 'features':['plans.feature.best_price','plans.feature.merch_10','plans.feature.freeze_14'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=mma_12m' }
      ],
      'all': [
        { 'id':'all_1m', 'price_eur':65, 'period_label':'plans.period.month', 'features':['plans.feature.all_gyms','plans.feature.unlimited','plans.feature.guest_friend'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=all_1m' },
        { 'id':'all_3m', 'price_eur':180, 'period_label':'plans.period.period', 'features':['plans.feature.save_15','plans.feature.priority','plans.feature.freeze_10'], 'is_featured': true, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=all_3m' },
        { 'id':'all_12m', 'price_eur':600, 'period_label':'plans.period.period', 'features':['plans.feature.max_benefit','plans.feature.merch_15','plans.feature.freeze_21'], 'is_featured': false, 'is_available': true, 'cta_type':'buy', 'link':'/checkout?plan=all_12m' }
      ]
    } %}
  {% else %}
    {% set pbd = plans_by_discipline %}
  {% endif %}

  {% set active_plan_ids = active_plan_ids if active_plan_ids is defined else (current_user.active_subscriptions if current_user.is_authenticated and current_user.active_subscriptions is defined else []) %}
  {% set active_disciplines = active_disciplines if active_disciplines is defined else (current_user.active_disciplines if current_user.is_authenticated and current_user.active_disciplines is defined else []) %}

  {% set order = ['boxing','wrestling','mma','all'] %}
  <div class="plans-panels">
    {% for key in order %}
      {% set plans = pbd.get(key, []) %}
      {% set user_has_active_for_pane = current_user.is_authenticated and (key in active_disciplines or (plans|map(attribute='id')|select('in', active_plan_ids)|list|length > 0)) %}
      <div id="panel-{{ key }}" class="plans-panel" role="tabpanel" aria-labelledby="tab-{{ key }}" data-key="{{ key }}" hidden>
        <div class="plans-grid" role="list">
          {% for p in plans %}
            {% set effective_cta = 'view' if (user_has_active_for_pane or (p.is_available is defined and not p.is_available)) else (p.cta_type or 'view') %}
            <article class="plan-card{% if p.is_featured %} featured{% endif %}" role="listitem">
              {% if p.is_featured %}<span class="plan-badge">{{ _('plans.badge.best') }}</span>{% endif %}
              <header class="plan-head">
                <h3 class="plan-name">{{ _('plans.titles.' ~ ('month_1' if p.id.endswith('1m') else ('month_3' if p.id.endswith('3m') else 'month_12'))) }}</h3>
                <p class="plan-desc">{{ _('plans.descr.' ~ ('1m' if p.id.endswith('1m') else ('3m' if p.id.endswith('3m') else '12m'))) }}</p>
              </header>
              <div class="plan-price">
                <span>€{{ p.price_eur }}</span>
                {% if p.period_label %}<span class="plan-period">{{ _(p.period_label) }}</span>{% endif %}
              </div>
              <div class="plan-price-note">{{ _('plans.includes_vat') }}</div>
              {% if p.features %}
                <ul class="plan-features">
                  {% for f in p.features %}
                    <li class="plan-feature">
                      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>
                      <span>{% if f is string and f.startswith('plans.') %}{{ t(f) }}{% else %}{{ f }}{% endif %}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
              <div class="plan-cta">
                {% if effective_cta == 'buy' %}
                  <button class="btn btn-accent" type="button" onclick="onPlanCtaClick(event, 'buy', '{{ p.link }}')">{{ _('plans.cta.buy') }}</button>
                {% else %}
                  <a class="btn btn-outline plan-link" href="{{ '/profile/subscriptions' if user_has_active_for_pane else (p.link or '/billing/plans') }}">{{ _('plans.cta.view') }}</a>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  <p class="plans-footnote">{{ _('plans.note') }}</p>
</section>
#}

<script>
/* Отключено: инициирование оплаты
async function createCheckout(price_id){
  try{
    const resp = await fetch('/billing/checkout/session', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({price_id})});
    const data = await resp.json();
    if (data.url) window.location = data.url; else alert("{{ _('Ошибка создания сессии оплаты') }}");
  }catch(e){ alert("{{ _('Ошибка сети') }}"); }
}
*/

// Mark today's day with the "Сегодня" chip
(function(){
  try{
    const base = ['E','T','K','N','R','L','P']; // Mon..Sun
    const code = base[(new Date().getDay() + 6) % 7]; // map JS 0..6 (Sun..Sat) to Mon..Sun index
    document.querySelectorAll('.day-head .today-chip').forEach(el => {
      if (el.getAttribute('data-day') === code) {
        el.hidden = false;
      } else {
        el.remove();
      }
    });
  }catch(e){ /* no-op */ }
})();

// Tabs: sync with URL hash and toggle panels
(function(){
  const mapKey = (hash) => {
    switch ((hash || '').toLowerCase()){
      case '#boxing': return 'boxing';
      case '#wrestling': return 'wrestling';
      case '#mma': return 'mma';
      default: return 'all';
    }
  };
  const tabs = Array.from(document.querySelectorAll('.plans-tab'));
  const panels = Array.from(document.querySelectorAll('.plans-panel'));
  const setActive = (key) => {
    tabs.forEach(btn => btn.setAttribute('aria-selected', btn.getAttribute('data-key') === key ? 'true' : 'false'));
    panels.forEach(p => {
      if (p.getAttribute('data-key') === key) p.removeAttribute('hidden'); else p.setAttribute('hidden','');
    });
  };
  const sync = () => setActive(mapKey(location.hash));
  tabs.forEach(btn => btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-key');
    const target = key === 'boxing' ? '#boxing' : key === 'wrestling' ? '#wrestling' : key === 'mma' ? '#mma' : '#all';
    if (location.hash !== target) location.hash = target; else sync();
  }));
  window.addEventListener('hashchange', sync);
  sync();
})();
function onPlanCtaClick(ev, cta, link){
  const btn = ev.currentTarget;
  if (cta === 'buy'){
    btn.disabled = true;
    btn.setAttribute('aria-busy','true');
    const isPath = typeof link === 'string' && link.startsWith('/');
    const action = isPath ? Promise.resolve().then(()=>{ window.location = link; }) : createCheckout(link);
    action.finally(()=>{
      btn.disabled = false;
      btn.removeAttribute('aria-busy');
    });
  } else if (link){
    window.location = link;
  }
}

// Process age display with localized suffix
(function(){
  const AGE_SUFFIX = '{{ _("age_suffix") }}';
  document.querySelectorAll('.age-display').forEach(el => {
    const age = el.getAttribute('data-age') || '';
    if (!age) return;
    
    // Remove any existing suffixes (a., л., y.o, y.)
    const cleaned = age.replace(/[aлy][.,o]*/gi, '').trim();
    
    // Add localized suffix
    el.textContent = cleaned + AGE_SUFFIX;
  });
})();
</script>
{% endblock %}