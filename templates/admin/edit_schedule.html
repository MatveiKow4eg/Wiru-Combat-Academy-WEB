{% extends "base.html" %}
{% block title %}{{ _('Редактор расписания') }}{% endblock %}
{% block extra_css %}
<style>
  :root { --accent: #e02525; }
  .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .days-tabs{ display:flex; gap:6px; border-bottom:1px solid var(--border); margin-top:6px; overflow:auto; }
  .days-tab{ appearance:none; background:transparent; color:var(--text); padding:8px 12px; border:0; cursor:pointer; font-weight:700; transition: background 0.2s; }
  .days-tab:hover { background: rgba(224,37,37,0.1); }
  .days-tab[aria-selected="true"]{ background: var(--accent); color: white; border-radius: 8px 8px 0 0; }

  .copy-bar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 10px 0 14px; }
  .copy-bar .input{ height: 36px; }

  .sched-card{ background: var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  .sched-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); }
  .sched-title{ margin:0; font-size:20px; }

  .sched-list { display: flex; flex-direction: column; gap: 16px; padding: 12px; }
  .card { background: #171717; border:1px solid var(--border); border-radius:12px; padding:12px; display:grid; grid-template-columns: 80px 1fr 120px 160px auto; gap:10px; align-items:center; transition: box-shadow 0.2s; }
  .card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
  .card .actions { display:flex; gap:6px; flex-wrap:wrap; }
  .card.editing { background: #181818; }
  .add-card { background: #121212; margin-bottom: 16px; }

  @media (max-width: 600px) {
    .card { grid-template-columns: 1fr; gap: 8px; }
    .card .actions { justify-content: center; }
  }

  .btn { padding:8px 12px; border-radius:20px; box-shadow:0 2px 4px rgba(0,0,0,0.3); transition: box-shadow 0.2s, transform 0.2s; }
  .btn:hover { box-shadow:0 4px 8px rgba(0,0,0,0.4); transform: translateY(-2px); }
  .btn-accent { background: var(--accent); color: white; }
  .btn--danger { background: #c00; color: white; }
  .btn--sm { padding:6px 10px; font-size:12px; border-radius:16px; }

  .input.time{ width:92px; }
  .input.coach{ min-width:160px; }
  .select-day{ height:32px; }

  .muted{ color: var(--muted) }

  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center; }
  .modal-content { background:var(--panel); padding:20px; border-radius:12px; max-width:400px; text-align:center; }
  .modal-content p { margin-bottom:16px; }
  .modal-content .btn { margin:0 8px; }
</style>
{% endblock %}
{% block content %}
<section class="container pad-y">
  <div class="toolbar">
    <a class="btn" href="{{ url_for('admin_dashboard') }}">← {{ _('Админ') }}</a>
    <a class="btn" href="{{ url_for('schedule_page') }}">{{ _('Открыть публичное расписание') }}</a>
  </div>
  <h1>{{ _('Редактор расписания') }}</h1>

  <nav class="days-tabs" role="tablist" aria-label="{{ _('Дни недели') }}">
    <button class="days-tab" role="tab" data-day="0" aria-selected="true">{{ _('Понедельник') }}</button>
    <button class="days-tab" role="tab" data-day="1" aria-selected="false">{{ _('Вторник') }}</button>
    <button class="days-tab" role="tab" data-day="2" aria-selected="false">{{ _('Среда') }}</button>
    <button class="days-tab" role="tab" data-day="3" aria-selected="false">{{ _('Четверг') }}</button>
    <button class="days-tab" role="tab" data-day="4" aria-selected="false">{{ _('Пятница') }}</button>
    <button class="days-tab" role="tab" data-day="5" aria-selected="false">{{ _('Суббота') }}</button>
    <button class="days-tab" role="tab" data-day="6" aria-selected="false">{{ _('Воскресенье') }}</button>
  </nav>

  <div class="copy-bar">
    <span class="muted">{{ _('Копировать день') }}:</span>
    <select id="copy-src" class="input" style="max-width:180px">
      <option value="" disabled selected>{{ _('Из') }}</option>
      <option value="0">{{ _('Понедельник') }}</option>
      <option value="1">{{ _('Вторник') }}</option>
      <option value="2">{{ _('Среда') }}</option>
      <option value="3">{{ _('Четверг') }}</option>
      <option value="4">{{ _('Пятниц��') }}</option>
      <option value="5">{{ _('Суббота') }}</option>
      <option value="6">{{ _('Воскресенье') }}</option>
    </select>
    <span class="muted">→</span>
    <select id="copy-dst" class="input" style="max-width:180px">
      <option value="" disabled selected>{{ _('В') }}</option>
      <option value="0">{{ _('Понедельник') }}</option>
      <option value="1">{{ _('Вторник') }}</option>
      <option value="2">{{ _('Среда') }}</option>
      <option value="3">{{ _('Четверг') }}</option>
      <option value="4">{{ _('Пятница') }}</option>
      <option value="5">{{ _('Суббота') }}</option>
      <option value="6">{{ _('Воскресенье') }}</option>
    </select>
    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="copy-replace"> {{ _('Заменить существующие') }}
    </label>
    <button class="btn btn-accent" id="copy-btn">{{ _('Скопировать') }}</button>
    <span id="copy-status" class="muted"></span>
  </div>

  <hr style="margin:20px 0; border-color:var(--border);">

  <div class="sched-card">
    <div class="sched-head">
      <h2 id="day-title" class="sched-title"></h2>
      <span class="muted" id="count-info"></span>
    </div>
    <div class="sched-body">
      <div id="add-card" class="card add-card">
        <input type="time" class="input time" id="add-time" required>
        <select class="input" id="add-discipline" required>
          <option value="" disabled selected>{{ _('Выберите') }}</option>
          <option value="boxing">{{ _('Бокс') }}</option>
          <option value="wrestling">{{ _('Борьба') }}</option>
          <option value="mma">{{ _('ММА') }}</option>
          <option value="other">{{ _('Другое') }}</option>
        </select>
        <input type="text" class="input" id="add-custom" placeholder="{{ _('Введите название занятия') }}" style="display:none;">
        <input type="text" class="input" id="add-age" placeholder="{{ _('Возраст, например: 13+') }}">
        <input type="text" class="input coach" id="add-coach" placeholder="{{ _('Например: Иван') }}">
        <div class="actions">
          <button class="btn btn-accent btn--sm" id="add-btn" title="{{ _('Быстрое добавление для выбранного дня') }}">{{ _('Добавить') }}</button>
        </div>
      </div>
      <div id="list" class="sched-list"></div>
    </div>
  </div>
</section>

<div id="copy-modal" class="modal">
  <div class="modal-content">
    <p id="copy-confirm-text"></p>
    <button class="btn btn-accent" onclick="confirmCopy()">{{ _('Да') }}</button>
    <button class="btn" onclick="closeModal()">{{ _('Нет') }}</button>
  </div>
</div>

<script>
// CSRF token helper
function getCookie(name){
  const m = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
  return m ? decodeURIComponent(m[2]) : '';
}
const CSRF_TOKEN = (function(){
  const meta = document.querySelector('meta[name="csrf-token"]');
  if(meta && meta.content) return meta.content;
  const input = document.querySelector('input[name="csrf_token"]');
  if(input && input.value) return input.value;
  const cookie = getCookie('csrf_token');
  return cookie || '';
})();

const DAY_FULL = [
  '{{ _('Понедельник') }}','{{ _('Вторник') }}','{{ _('Среда') }}','{{ _('Четверг') }}','{{ _('Пятница') }}','{{ _('Суббота') }}','{{ _('Воскресенье') }}'
];

let ALL = [];
let ACTIVE_DAY = (function(){ const js = new Date().getDay(); return js === 0 ? 6 : js - 1; })();

function h(tag, attrs={}, ...children){
  const el = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k === 'class') el.className = v;
    else if(k === 'html') el.innerHTML = v;
    else if(k.startsWith('on')) el.addEventListener(k.slice(2), v);
    else if(v != null) el.setAttribute(k, v);
  }
  for(const c of children){
    if(c == null) continue;
    if(typeof c === 'string') el.appendChild(document.createTextNode(c)); else el.appendChild(c);
  }
  return el;
}

async function api(path, opts={}){
  const headers = Object.assign({ 'Content-Type':'application/json' }, opts.headers||{});
  if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
  const resp = await fetch(path, Object.assign({}, opts, { headers }));
  const data = await resp.json().catch(()=>({}));
  if(!resp.ok){ throw new Error(data.error || ('HTTP '+resp.status)); }
  return data;
}

async function load(){
  ALL = await api('/admin/schedule/data');
  render();
}

function setActiveDay(day){
  ACTIVE_DAY = day;
  document.querySelectorAll('.days-tab').forEach(btn => {
    const sel = Number(btn.getAttribute('data-day')) === ACTIVE_DAY;
    btn.setAttribute('aria-selected', sel ? 'true' : 'false');
  });
  render();
}

function render(){
  document.getElementById('day-title').textContent = DAY_FULL[ACTIVE_DAY];
  const list = document.getElementById('list');
  list.innerHTML = '';
  const rows = ALL.filter(x => x.day_of_week === ACTIVE_DAY).sort((a,b)=>a.time.localeCompare(b.time));
  document.getElementById('count-info').textContent = `${rows.length} {{ _('занятий') }}`;
  rows.forEach(it => list.appendChild(cardView(it)));
}

function cardView(it){
  const discLabel = it.discipline === 'boxing' ? '{{ _('Бокс') }}' : (it.discipline === 'wrestling' ? '{{ _('Борьба') }}' : (it.discipline === 'mma' ? '{{ _('ММА') }}' : (it.discipline === 'other' ? '{{ _('Другое') }}' : '—')));
  
  const daySelect = h('select', {class:'select-day'});
  for(let i=0;i<7;i++){
    const opt = h('option', {value:String(i)}, DAY_FULL[i]);
    if(i === ACTIVE_DAY) opt.selected = true;
    daySelect.appendChild(opt);
  }
  
  const card = h('div', {class:'card'},
    h('div', {}, it.time),
    h('div', {}, it.activity),
    h('div', {}, discLabel),
    h('div', {}, it.coach || ''),
    h('div', {class:'actions'},
      h('button', {class:'btn btn--sm', onclick: ()=>startEdit(card, it)}, '{{ _('Изменить') }}'),
      h('button', {class:'btn btn--sm btn--danger', onclick: ()=>doDelete(it)}, '{{ _('Удалить') }}'),
      h('span', {class:'muted'}, ' | '),
      daySelect,
      h('button', {class:'btn btn--sm', title:'{{ _('Перенести на выбранный день') }}', onclick: async()=>{
        const to = Number(daySelect.value);
        if(to === it.day_of_week) return;
        await api(`/admin/schedule/item/${it.id}`, { method:'PUT', body: JSON.stringify({ day_of_week: to }) });
        await load();
      }}, '→ {{ _('Перенести') }}'),
      h('button', {class:'btn btn--sm', title:'{{ _('Дублировать на выбранный день') }}', onclick: async()=>{
        const to = Number(daySelect.value);
        await api('/admin/schedule/item', { method:'POST', body: JSON.stringify({ day_of_week: to, time: it.time, activity: it.activity, discipline: it.discipline, coach: it.coach, age: it.age }) });
        await load();
      }}, '⊕ {{ _('Дублировать') }}')
    )
  );
  return card;
}

function startEdit(card, it){
  card.classList.add('editing');
  card.innerHTML = '';
  const time = h('input', {class:'input time', type:'time', value: it.time, required:true});
  const disc = h('select', {class:'input', required:true});
  [['', '{{ _('Выберите') }}'], ['boxing','{{ _('Бокс') }}'], ['wrestling','{{ _('Борьба') }}'], ['mma','{{ _('ММА') }}'], ['other','{{ _('Другое') }}']].forEach(([v, lbl])=>{
    const o = h('option', {value:v}, lbl); if(v === (it.discipline||'')) o.selected = true; disc.appendChild(o);
  });
  const custom = h('input', {class:'input', type:'text', value: '', placeholder:'{{ _('Введите название занятия') }}', style:{display: (it.discipline === 'other' ? 'block' : 'none')}});
  const age = h('input', {class:'input', type:'text', value: it.age || '', placeholder:'{{ _('Возраст, например: 13+') }}'});
  const coach = h('input', {class:'input coach', type:'text', value: it.coach || ''});
  disc.addEventListener('change', () => {
    const isOther = disc.value === 'other';
    custom.style.display = isOther ? 'block' : 'none';
    if (isOther) custom.value = it.activity.split(' ')[0]; // assuming activity is "custom age", take custom part
  });
  card.appendChild(time);
  card.appendChild(disc);
  card.appendChild(custom);
  card.appendChild(age);
  card.appendChild(coach);
  card.appendChild(h('div', {class:'actions'},
    h('button', {class:'btn btn-accent btn--sm', onclick: async()=>{
      const payload = { time: time.value.trim(), discipline: disc.value, coach: coach.value.trim() || null };
      if (disc.value === 'other') {
        payload.activity = custom.value.trim();
      }
      payload.age = age.value.trim() || null;
      try{ await api(`/admin/schedule/item/${it.id}`, { method:'PUT', body: JSON.stringify(payload) }); await load(); }catch(e){ alert(e.message); }
    }}, '{{ _('Сохранить') }}'),
    h('button', {class:'btn btn--sm', onclick: ()=>load()}, '{{ _('Отмена') }}')
  ));
}

async function doDelete(it){
  if(!confirm('{{ _('Удалить тренировку?') }}')) return;
  try{ await api(`/admin/schedule/item/${it.id}`, { method:'DELETE' }); await load(); }catch(e){ alert(e.message); }
}

// Add new
async function onAdd(){
  const time = document.getElementById('add-time');
  const coach = document.getElementById('add-coach');
  const disc = document.getElementById('add-discipline');
  const age = document.getElementById('add-age');
  const custom = document.getElementById('add-custom');
  if(!time.value || !disc.value) return;
  const payload = { day_of_week: ACTIVE_DAY, time: time.value, discipline: disc.value, coach: (coach.value||'').trim() || null };
  if (disc.value === 'other') {
    payload.activity = (custom.value||'').trim();
  }
  payload.age = (age.value||'').trim() || null;
  try{ await api('/admin/schedule/item', { method:'POST', body: JSON.stringify(payload) }); time.value=''; disc.value=''; age.value=''; coach.value=''; custom.value=''; await load(); }catch(e){ alert(e.message); }
}

// Toggle custom input for add form
const addDisc = document.getElementById('add-discipline');
const addCustom = document.getElementById('add-custom');
addDisc.addEventListener('change', () => {
  addCustom.style.display = addDisc.value === 'other' ? 'block' : 'none';
});

document.getElementById('add-btn').addEventListener('click', (e)=>{ e.preventDefault(); onAdd(); });

// Copy day
let pendingCopy = null;
function showCopyModal(src, dst, replace) {
  const srcName = DAY_FULL[src];
  const dstName = DAY_FULL[dst];
  const action = replace ? '{{ _('заменит существующие занятия') }}' : '{{ _('добавит занятия, пропуская дубликаты') }}';
  document.getElementById('copy-confirm-text').textContent = `{{ _('Подтвердите копирование расписания из') }} ${srcName} {{ _('в') }} ${dstName}. {{ _('Это') }} ${action}.`;
  document.getElementById('copy-modal').style.display = 'flex';
  pendingCopy = {src, dst, replace};
}

function closeModal() {
  document.getElementById('copy-modal').style.display = 'none';
  pendingCopy = null;
}

async function confirmCopy() {
  if (!pendingCopy) return;
  const {src, dst, replace} = pendingCopy;
  const status = document.getElementById('copy-status');
  try{
    status.textContent = '{{ _('Выполняется...') }}';
    const res = await api('/admin/schedule/copy_day', { method:'POST', body: JSON.stringify({ source_day: src, target_day: dst, replace }) });
    status.textContent = `{{ _('Готово') }} (+${res.created})`;
    await load();
  }catch(e){ status.textContent = e.message; }
  closeModal();
}

document.getElementById('copy-btn').addEventListener('click', (e)=>{
  e.preventDefault();
  const src = Number(document.getElementById('copy-src').value);
  const dst = Number(document.getElementById('copy-dst').value);
  const replace = document.getElementById('copy-replace').checked;
  if(Number.isNaN(src) || Number.isNaN(dst) || src === dst) return;
  showCopyModal(src, dst, replace);
});

// Tabs
Array.from(document.querySelectorAll('.days-tab')).forEach(btn=>{
  btn.addEventListener('click', ()=> setActiveDay(Number(btn.getAttribute('data-day'))));
});

setActiveDay(ACTIVE_DAY);
load();
</script>
{% endblock %}