{% extends "base.html" %}
{% block title %}{{ _('–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è') }}{% endblock %}
{% block extra_css %}
<style>
  :root {
    --accent: #e02525;
    --bg-primary: #0D0D0D;
    --bg-secondary: #121212;
    --surface: #1A1A1A;
    --surface-hover: #1F1F1F;
    --border: #2A2A2A;
    --text-primary: #EDEDED;
    --text-secondary: #9AA0A6;
    --success: #34A853;
    --danger: #EA4335;
    --warning: #FBBC04;
  }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  /* Page Layout */
  .schedule-editor {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 16px 40px;
  }

  /* Sticky Header */
  .editor-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--bg-primary);
    padding: 20px 0 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .editor-title {
    font-size: 32px;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  /* Days Tabs */
  .days-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    overflow-x: auto;
    scrollbar-width: thin;
  }

  .days-tabs::-webkit-scrollbar {
    height: 4px;
  }

  .days-tabs::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
  }

  .day-tab {
    position: relative;
    flex: 1;
    min-width: 120px;
    padding: 12px 16px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: center;
  }

  .day-tab:hover {
    background: var(--surface);
    border-color: var(--accent);
  }

  .day-tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .day-tab.today:not(.active)::before {
    content: '';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
  }

  .day-badge {
    display: inline-block;
    margin-left: 6px;
    padding: 2px 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    font-size: 11px;
    font-weight: 700;
  }

  /* Copy Day Bar */
  .copy-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .copy-bar-label {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
  }

  .copy-arrow {
    color: var(--text-secondary);
    font-size: 18px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover {
    background: #c91f1f;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(224, 37, 37, 0.3);
  }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-primary);
  }

  .btn-secondary:hover {
    background: var(--surface);
    border-color: var(--text-secondary);
  }

  .btn-danger {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
  }

  .btn-danger:hover {
    background: rgba(234, 67, 53, 0.1);
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
  }

  .btn-icon {
    padding: 8px;
    width: 36px;
    height: 36px;
  }

  /* Input Fields */
  .input {
    padding: 10px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.15s ease;
  }

  .input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(224, 37, 37, 0.1);
  }

  .input::placeholder {
    color: var(--text-secondary);
  }

  .input.error {
    border-color: var(--danger);
  }

  .input-error-text {
    display: block;
    margin-top: 4px;
    color: var(--danger);
    font-size: 12px;
  }

  .input-time {
    width: 100px;
    font-family: 'Courier New', monospace;
  }

  .input-age {
    width: 80px;
  }

  .age-range {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .age-separator {
    color: var(--text-secondary);
    font-weight: 600;
  }

  .input-coach {
    width: 100%;
  }

  /* Add Panel */
  .add-panel {
    margin-bottom: 24px;
    padding: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  .add-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .add-panel-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .add-panel.collapsed .add-panel-body {
    display: none;
  }

  .add-form {
    display: grid;
    grid-template-columns: 100px 180px 180px 1fr auto;
    gap: 12px;
    align-items: start;
  }

  .add-form-actions {
    display: flex;
    gap: 8px;
  }

  .form-hint {
    grid-column: 1 / -1;
    margin-top: -4px;
    color: var(--text-secondary);
    font-size: 12px;
  }

  /* Schedule List */
  .schedule-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Selection Mode Toolbar */
  .selection-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .selection-controls {
    display: none;
    align-items: center;
    gap: 12px;
  }

  .selection-toolbar.active .selection-controls {
    display: flex;
  }

  .btn-link {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    text-decoration: underline;
  }

  .btn-link:hover {
    color: var(--text-primary);
  }

  .schedule-card {
    display: grid;
    grid-template-columns: 24px 80px 1fr auto;
    gap: 16px;
    align-items: center;
    padding: 14px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    transition: all 0.15s ease;
    position: relative;
  }

  .schedule-card.editing {
    background: var(--surface-hover);
    border-color: var(--accent);
  }

  /* Selection Mode Styles */
  .schedule-card.selectable {
    cursor: pointer;
    user-select: none;
  }

  .schedule-card.selectable:hover {
    background: var(--surface-hover);
  }

  .schedule-card.selected {
    background: var(--surface-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(224, 37, 37, 0.2);
  }

  .schedule-card .card-checkbox {
    display: none;
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--accent);
  }

  .schedule-card.selectable .card-checkbox {
    display: block;
  }

  .schedule-card.selectable .drag-handle {
    display: none;
  }

  .schedule-card.selectable .card-actions {
    opacity: 0.3;
    pointer-events: none;
  }

  .drag-handle {
    color: var(--text-secondary);
    cursor: grab;
    font-size: 18px;
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .card-time {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-meta {
    display: flex;
    gap: 12px;
    font-size: 13px;
    color: var(--text-secondary);
  }

  .card-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .card-actions {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  /* Edit Form in Card */
  .edit-form {
    grid-column: 2 / -1;
    display: grid;
    grid-template-columns: 100px 1fr 140px 180px auto;
    gap: 12px;
    align-items: start;
  }

  .edit-form-actions {
    display: flex;
    gap: 8px;
  }

  /* Empty State */
  .empty-state {
    padding: 60px 20px;
    text-align: center;
    color: var(--text-secondary);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
  }

  .empty-state-text {
    font-size: 14px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 480px;
    width: 100%;
  }

  .modal-header {
    margin-bottom: 16px;
  }

  .modal-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
  }

  .modal-body {
    margin-bottom: 24px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .modal-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 200;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .toast.success {
    border-color: var(--success);
  }

  .toast.error {
    border-color: var(--danger);
  }

  .toast-icon {
    font-size: 20px;
  }

  .toast.success .toast-icon {
    color: var(--success);
  }

  .toast.error .toast-icon {
    color: var(--danger);
  }

  .toast-message {
    flex: 1;
    font-size: 14px;
  }

  /* Dropdown Menu */
  .dropdown {
    position: relative;
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 2px);
    right: 0;
    min-width: 160px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 150;
    padding: 4px;
  }

  /* Prevent gap between button and menu */
  .dropdown-menu::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 0;
    width: 100%;
    height: 6px;
  }

  .dropdown.active .dropdown-menu {
    display: block;
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    color: var(--text-primary);
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.1s ease;
  }

  .dropdown-item:hover {
    background: var(--surface-hover);
  }

  .dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
  }

  /* Responsive */
  @media (max-width: 1199px) {
    .add-form {
      grid-template-columns: 100px 180px 180px auto;
    }
    
    .input-coach {
      grid-column: 1 / -1;
    }

    .edit-form {
      grid-template-columns: 100px 1fr 140px auto;
    }
  }

  @media (max-width: 767px) {
    .editor-title {
      font-size: 24px;
    }

    .day-tab {
      min-width: 100px;
      font-size: 13px;
      padding: 10px 12px;
    }

    .copy-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .add-form {
      grid-template-columns: 1fr;
    }

    .input-time,
    .input-age,
    .input-coach {
      width: 100%;
      min-width: 0;
    }

    .schedule-card {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .drag-handle {
      display: none;
    }

    .card-time {
      font-size: 14px;
    }

    .card-actions {
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .edit-form {
      grid-template-columns: 1fr;
    }
  }

  /* Days multi-select styles */
  .multi-select-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    width: 100%;
  }
  .days-options input[type="checkbox"] {
    accent-color: var(--accent);
    width: 16px;
    height: 16px;
  }

  /* Ensure the add-days dropdown overlays and doesn't shift layout */
  #add-days-dropdown {
    position: relative;
    width: 100%;
  }
  #add-days-dropdown .dropdown-menu,
  #add-days-dropdown .dropdown,
  #add-days-dropdown .dropdown-list,
  #add-days-dropdown .dropdown-content,
  #add-days-dropdown .dropdown-body,
  #add-days-dropdown .days-menu {
    position: absolute !important;
    top: calc(100% + 4px);
    left: 0;
    width: 100%;
    z-index: 50;
    margin: 0;
  }

  /* Loading State */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="schedule-editor">
  <!-- Sticky Header -->
  <div class="editor-header">
    <div class="header-top">
      <h1 class="editor-title">{{ _('–†–µ–¥–∞–∫—Ç–æ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è') }}</h1>
    </div>

    <!-- Days Tabs -->
    <div class="days-tabs" id="days-tabs"></div>

      </div>

  <!-- Add Panel -->
  <div class="add-panel" id="add-panel">
    <div class="add-panel-header">
      <h3 class="add-panel-title">{{ _('–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ') }}</h3>
    </div>
    <div class="add-panel-body">
      <form class="add-form" id="add-form" onsubmit="return false;">
        <input type="time" class="input input-time" id="add-time" placeholder="00:00" required>
        <div class="dropdown" id="add-days-dropdown">
          <button type="button" class="input multi-select-toggle" id="add-days-toggle" onclick="toggleDropdown(event)">
            {{ _('–î–Ω–∏') }}: {{ _('–í—ã–±–µ—Ä–∏—Ç–µ') }}
          </button>
          <div class="dropdown-menu" style="padding:8px 12px;">
            <div class="days-options" id="add-days">
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="0" class="days-checkbox">
                <span>{{ _('–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫') }}</span>
              </label>
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="1" class="days-checkbox">
                <span>{{ _('–í—Ç–æ—Ä–Ω–∏–∫') }}</span>
              </label>
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="2" class="days-checkbox">
                <span>{{ _('–°—Ä–µ–¥–∞') }}</span>
              </label>
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="3" class="days-checkbox">
                <span>{{ _('–ß–µ—Ç–≤–µ—Ä–≥') }}</span>
              </label>
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="4" class="days-checkbox">
                <span>{{ _('–ü—è—Ç–Ω–∏—Ü–∞') }}</span>
              </label>
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="5" class="days-checkbox">
                <span>{{ _('–°—É–±–±–æ—Ç–∞') }}</span>
              </label>
              <label class="dropdown-item" style="gap:10px;">
                <input type="checkbox" name="add-days" value="6" class="days-checkbox">
                <span>{{ _('–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ') }}</span>
              </label>
            </div>
          </div>
        </div>
        <select class="input" id="add-group" required>
          <option value="" disabled selected>{{ _('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É') }}</option>
          <option value="mma_10_14">MMA 10‚Äì14 {{ _('–ª–µ—Ç') }}</option>
          <option value="mma_15_plus">MMA 15+ {{ _('–ª–µ—Ç') }}</option>
          <option value="boxing_5_7">{{ _('–ë–æ–∫—Å') }} 5‚Äì7 {{ _('–ª–µ—Ç') }}</option>
          <option value="boxing_8_11">{{ _('–ë–æ–∫—Å') }} 8‚Äì11 {{ _('–ª–µ—Ç') }}</option>
          <option value="boxing_12_plus">{{ _('–ë–æ–∫—Å') }} 12+ {{ _('–ª–µ—Ç') }}</option>
          <option value="sparring">{{ _('–°–ø–∞—Ä—Ä–∏–Ω–≥') }}</option>
          <option value="general_circuit">{{ _('–û–±—â–µ—É–∫—Ä–µ–ø–ª—è—é—â–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏') }}</option>
        </select>
                        <select class="input input-coach" id="add-coach">
          <option value="">{{ _('–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞') }}</option>
        </select>
        <div class="add-form-actions">
          <button type="submit" class="btn btn-primary btn-sm">{{ _('–î–æ–±–∞–≤–∏—Ç—å') }}</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="resetAddForm()">{{ _('–û—á–∏—Å—Ç–∏—Ç—å') }}</button>
        </div>
              </form>
    </div>
  </div>

  <!-- Selection Toolbar -->
  <div class="selection-toolbar" id="selection-toolbar">
    <button class="btn btn-secondary btn-sm" id="select-mode-btn" onclick="toggleSelectionMode()" aria-pressed="false">
      {{ _('–í—ã–±—Ä–∞—Ç—å') }}
    </button>
    <div class="selection-controls">
      <button 
        class="btn btn-danger btn-sm" 
        id="delete-selected-btn" 
        onclick="deleteSelected()" 
        disabled
        data-text-template="{{ _('–£–¥–∞–ª–∏—Ç—å') }}">
        {{ _('–£–¥–∞–ª–∏—Ç—å') }} (0)
      </button>
      <button 
        class="btn-link" 
        id="select-all-btn" 
        onclick="toggleSelectAll()"
        data-select-all-text="{{ _('–í—ã–±—Ä–∞—Ç—å –≤—Å–µ') }}"
        data-deselect-all-text="{{ _('–°–Ω—è—Ç—å –≤—Å—ë') }}">
        {{ _('–í—ã–±—Ä–∞—Ç—å –≤—Å–µ') }}
      </button>
    </div>
  </div>

  <!-- Schedule List -->
  <div id="schedule-list" class="schedule-list"></div>
</div>

<!-- Modals -->
<div class="modal" id="confirm-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">{{ _('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ') }}</h3>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
      <button class="btn btn-primary" id="modal-confirm">{{ _('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å') }}</button>
    </div>
  </div>
</div>

<script>
// CSRF Token
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return m ? decodeURIComponent(m[2]) : '';
}

const CSRF_TOKEN = (() => {
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta?.content) return meta.content;
  const input = document.querySelector('input[name="csrf_token"]');
  if (input?.value) return input.value;
  return getCookie('csrf_token') || '';
})();

// Constants
const DAY_NAMES = [
  '{{ _('–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫') }}',
  '{{ _('–í—Ç–æ—Ä–Ω–∏–∫') }}',
  '{{ _('–°—Ä–µ–¥–∞') }}',
  '{{ _('–ß–µ—Ç–≤–µ—Ä–≥') }}',
  '{{ _('–ü—è—Ç–Ω–∏—Ü–∞') }}',
  '{{ _('–°—É–±–±–æ—Ç–∞') }}',
  '{{ _('–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ') }}'
];

const DAY_NAMES_SHORT = ['{{ _('–ü–Ω') }}', '{{ _('–í—Ç') }}', '{{ _('–°—Ä') }}', '{{ _('–ß—Ç') }}', '{{ _('–ü—Ç') }}', '{{ _('–°–±') }}', '{{ _('–í—Å') }}'];

// Fixed groups mapping used by add/edit forms
const GROUPS = {
  mma_10_14: { discipline: 'mma', age: '10‚Äì14', label: 'MMA 10‚Äì14 {{ _('–ª–µ—Ç') }}' },
  mma_15_plus: { discipline: 'mma', age: '15+', label: 'MMA 15+ {{ _('–ª–µ—Ç') }}' },
  boxing_5_7: { discipline: 'boxing', age: '5‚Äì7', label: '{{ _('–ë–æ–∫—Å') }} 5‚Äì7 {{ _('–ª–µ—Ç') }}' },
  boxing_8_11: { discipline: 'boxing', age: '8‚Äì11', label: '{{ _('–ë–æ–∫—Å') }} 8‚Äì11 {{ _('–ª–µ—Ç') }}' },
  boxing_12_plus: { discipline: 'boxing', age: '12+', label: '{{ _('–ë–æ–∫—Å') }} 12+ {{ _('–ª–µ—Ç') }}' },
  sparring: { discipline: 'sparring', age: '', label: '{{ _('–°–ø–∞—Ä—Ä–∏–Ω–≥') }}' },
  general_circuit: { discipline: 'other', age: '', label: '{{ _('–û–±—â–µ—É–∫—Ä–µ–ø–ª—è—é—â–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏') }}' },
};

function getGroupKey(discipline, age) {
  if (!discipline) return '';
  const cleanedAge = (age || '').replace(/[a–ªy][.,o]*/gi, '').trim();
  for (const [key, conf] of Object.entries(GROUPS)) {
    if (conf.discipline === discipline && conf.age === cleanedAge) {
      return key;
    }
  }
  return '';
}

// Localized age suffix
const AGE_SUFFIX = '{{ _('age_suffix') }}';
const AGE_PREFIX_TO = '{{ _('–¥–æ') }}';

// Debug: log the values
console.log('AGE_SUFFIX:', AGE_SUFFIX);
console.log('AGE_PREFIX_TO:', AGE_PREFIX_TO);

// State
let scheduleData = [];
let activeDay = (() => {
  const js = new Date().getDay();
  return js === 0 ? 6 : js - 1;
})();
const todayDay = activeDay;

// Coaches data
let COACHES = [];
async function loadCoaches() {
  try {
    const list = await api('/admin/coaches');
    COACHES = Array.isArray(list) ? list.filter(Boolean) : [];
  } catch (e) {
    COACHES = [];
  }
  populateAddCoachSelect();
}

function populateCoachOptions(selectEl, selected) {
  if (!selectEl) return;
  const current = selected || '';
  // Reset options
  selectEl.innerHTML = '';
  const empty = document.createElement('option');
  empty.value = '';
  empty.textContent = '{{ _('–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞') }}';
  selectEl.appendChild(empty);

  const names = [...COACHES];
  if (current && !names.includes(current)) {
    names.unshift(current);
  }
  names.forEach((n) => {
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    if (n === current) opt.selected = true;
    selectEl.appendChild(opt);
  });
}

function populateAddCoachSelect() {
  const el = document.getElementById('add-coach');
  populateCoachOptions(el, '');
}

// API Helper
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...opts.headers };
  if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
  
  const resp = await fetch(path, { ...opts, headers });
  const data = await resp.json().catch(() => ({}));
  
  if (!resp.ok) {
    throw new Error(data.error || `HTTP ${resp.status}`);
  }
  
  return data;
}

// Toast Notifications
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span class="toast-icon">${type === 'success' ? '‚úì' : '‚úï'}</span>
    <span class="toast-message">${message}</span>
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.2s ease reverse';
    setTimeout(() => toast.remove(), 200);
  }, 3000);
}

// Initialize
async function init() {
  await loadCoaches();
  renderDaysTabs();
  setupEventListeners();
  initDaysSelection();
  await loadSchedule();
}

// Render Days Tabs
function renderDaysTabs() {
  const container = document.getElementById('days-tabs');
  container.innerHTML = '';
  
  DAY_NAMES.forEach((name, index) => {
    const tab = document.createElement('button');
    tab.className = 'day-tab';
    tab.dataset.day = index;
    
    if (index === activeDay) tab.classList.add('active');
    if (index === todayDay) tab.classList.add('today');
    
    const count = scheduleData.filter(item => item.day_of_week === index).length;
    tab.innerHTML = `${DAY_NAMES_SHORT[index]}${index === activeDay && count > 0 ? `<span class="day-badge">${count}</span>` : ''}`;
    
    tab.onclick = () => setActiveDay(index);
    container.appendChild(tab);
  });
}

// Populate Copy Selects

// Set Active Day
function setActiveDay(day) {
  activeDay = day;
  renderDaysTabs();
  renderScheduleList();
}

// Load Schedule
async function loadSchedule() {
  try {
    scheduleData = await api('/admin/schedule/data');
    renderDaysTabs();
    renderScheduleList();
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// Render Schedule List
function renderScheduleList() {
  const container = document.getElementById('schedule-list');
  const dayItems = scheduleData
    .filter(item => item.day_of_week === activeDay)
    .sort((a, b) => a.time.localeCompare(b.time));
  
  if (dayItems.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìÖ</div>
        <div class="empty-state-title">{{ _('–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–Ω—è—Ç–∏–π') }}</div>
        <div class="empty-state-text">{{ _('–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è') }}</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  dayItems.forEach(item => {
    container.appendChild(createScheduleCard(item));
  });
}

// Create Schedule Card
function createScheduleCard(item) {
  const card = document.createElement('div');
  card.className = 'schedule-card';
  card.dataset.id = item.id;
  
  let activityDisplay;
  if (item.discipline === 'other') {
    activityDisplay = item.activity || '{{ _('–î—Ä—É–≥–æ–µ') }}';
  } else {
    const labels = {
      boxing: '{{ _('–ë–æ–∫—Å') }}',
      wrestling: '{{ _('–ë–æ—Ä—å–±–∞') }}',
      mma: '{{ _('–ú–ú–ê') }}',
      sparring: '{{ _('–°–ø–∞—Ä—Ä–∏–Ω–≥') }}'
    };
    activityDisplay = labels[item.discipline] || item.activity;
    if (item.age) {
      // Remove old suffixes and add localized one
      const cleanedAge = item.age.replace(/[a–ªy][.,o]*/gi, '').trim();
      activityDisplay += ` ${cleanedAge}${AGE_SUFFIX}`;
    }
  }
  
  card.innerHTML = `
    <div class="drag-handle" title="{{ _('–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å') }}">‚ãÆ‚ãÆ</div>
    <div class="card-time">${item.time}</div>
    <div class="card-info">
      <div class="card-title">${activityDisplay}</div>
      ${item.coach ? `<div class="card-meta"><span class="card-meta-item">üë§ ${item.coach}</span></div>` : ''}
    </div>
    <div class="card-actions">
      <button class="btn btn-secondary btn-sm" onclick="editItem(${item.id})">{{ _('–ò–∑–º–µ–Ω–∏—Ç—å') }}</button>
      <div class="dropdown">
        <button class="btn btn-secondary btn-icon btn-sm" onclick="toggleDropdown(event)">‚ãØ</button>
        <div class="dropdown-menu">
          <div class="dropdown-item" onclick="moveItem(${item.id})">üì§ {{ _('–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏') }}</div>
          <div class="dropdown-item" onclick="duplicateItem(${item.id})">üìã {{ _('–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å') }}</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" style="color: var(--danger);" onclick="deleteItem(${item.id})">üóë {{ _('–£–¥–∞–ª–∏—Ç—å') }}</div>
        </div>
      </div>
    </div>
  `;
  
  return card;
}

// Edit Item
function editItem(id) {
  const item = scheduleData.find(i => i.id === id);
  if (!item) return;
  
  const card = document.querySelector(`[data-id="${id}"]`);
  card.classList.add('editing');
  
  // Extract custom name for 'other' discipline
  let customName = '';
  if (item.discipline === 'other' && item.activity) {
    customName = item.age && item.activity.endsWith(' ' + item.age) 
      ? item.activity.slice(0, -(item.age.length + 1))
      : item.activity;
  }
  
  // Parse age range
  const ageRange = parseAgeRange(item.age);
  
  card.innerHTML = `
    <div></div>
    <form class="edit-form" onsubmit="return saveEdit(event, ${id})">
      <input type="time" class="input input-time" value="${item.time}" required>
      <select class="input" id="edit-group-${id}" required>
        <option value="" disabled>{{ _('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É') }}</option>
        ${Object.entries(GROUPS).map(([key, conf]) => `<option value="${key}">${conf.label}</option>`).join('')}
      </select>
      <select class="input input-coach" id="edit-coach-${id}">
        <option value="">{{ _('–ë–µ–∑ —Ç—Ä–µ–Ω–µ—Ä–∞') }}</option>
      </select>
      <div class="edit-form-actions">
        <button type="submit" class="btn btn-primary btn-sm">{{ _('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å') }}</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="loadSchedule()">{{ _('–û—Ç–º–µ–Ω–∞') }}</button>
      </div>
    </form>
  `;
  
  // Set selected group and populate coach
  const groupSelect = document.getElementById(`edit-group-${id}`);
  groupSelect.value = getGroupKey(item.discipline, item.age) || '';
  populateCoachOptions(document.getElementById(`edit-coach-${id}`), item.coach || '');
}

// Save Edit
async function saveEdit(event, id) {
  event.preventDefault();
  const form = event.target;
  
  const inputs = form.querySelectorAll('input, select');
  const groupKey = document.getElementById(`edit-group-${id}`).value;
  const conf = GROUPS[groupKey];
  if (!conf) return false;

  const payload = {
    time: inputs[0].value.trim(),
    discipline: conf.discipline,
    age: conf.age,
    coach: (document.getElementById(`edit-coach-${id}`)?.value || '').trim() || null
  };
  if (conf.discipline === 'other') {
    payload.activity = conf.label;
  }
  
  try {
    await api(`/admin/schedule/item/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
    await loadSchedule();
    showToast('{{ _('–ó–∞–Ω—è—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ') }}');
  } catch (error) {
    showToast(error.message, 'error');
  }
  
  return false;
}

// Delete Item
function deleteItem(id) {
  const item = scheduleData.find(i => i.id === id);
  if (!item) return;
  
  showModal(
    '{{ _('–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ?') }}',
    `{{ _('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å') }} "${item.activity}" {{ _('–≤') }} ${item.time}?`,
    async () => {
      try {
        await api(`/admin/schedule/item/${id}`, { method: 'DELETE' });
        await loadSchedule();
        showToast('{{ _('–ó–∞–Ω—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ') }}');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }
  );
}

// Move Item
function moveItem(id) {
  // TODO: Implement move modal
  showToast('{{ _('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ') }}', 'error');
}

// Duplicate Item
async function duplicateItem(id) {
  const item = scheduleData.find(i => i.id === id);
  if (!item) return;
  
  try {
    await api('/admin/schedule/item', {
      method: 'POST',
      body: JSON.stringify({
        day_of_week: activeDay,
        time: item.time,
        activity: item.activity,
        discipline: item.discipline,
        coach: item.coach,
        age: item.age
      })
    });
    await loadSchedule();
    showToast('{{ _('–ó–∞–Ω—è—Ç–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–æ') }}');
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// Helper function to format age range (WITHOUT suffix for storage)
function formatAgeRangeForStorage(from, to) {
  if (from && to) {
    return `${from}‚Äì${to}`;
  } else if (from) {
    return `${from}+`;
  } else if (to) {
    return `${AGE_PREFIX_TO} ${to}`;
  }
  return null;
}

// Helper function to format age range WITH suffix for display
function formatAgeRange(from, to) {
  if (from && to) {
    return `${from}‚Äì${to}${AGE_SUFFIX}`;
  } else if (from) {
    return `${from}+${AGE_SUFFIX}`;
  } else if (to) {
    return `${AGE_PREFIX_TO} ${to}${AGE_SUFFIX}`;
  }
  return null;
}

// Helper function to parse age range
function parseAgeRange(ageStr) {
  if (!ageStr) return { from: '', to: '' };
  
  // Remove "a.", "–ª.", "y." suffixes and trim
  const cleaned = ageStr.replace(/[a–ªy][.,]/g, '').trim();
  
  // Check for range (e.g., "6‚Äì12" or "6-12")
  const rangeMatch = cleaned.match(/^(\d+)\s*[‚Äì-]\s*(\d+)$/);
  if (rangeMatch) {
    return { from: rangeMatch[1], to: rangeMatch[2] };
  }
  
  // Check for "from+" (e.g., "13+")
  const plusMatch = cleaned.match(/^(\d+)\+$/);
  if (plusMatch) {
    return { from: plusMatch[1], to: '' };
  }
  
  // Check for "–¥–æ X" / "kuni X" / "to X" (e.g., "–¥–æ 12")
  const toMatch = cleaned.match(/^(?:–¥–æ|kuni|to)\s+(\d+)$/i);
  if (toMatch) {
    return { from: '', to: toMatch[1] };
  }
  
  // Single number
  const singleMatch = cleaned.match(/^(\d+)$/);
  if (singleMatch) {
    return { from: singleMatch[1], to: singleMatch[1] };
  }
  
  return { from: '', to: '' };
}

function updateDaysToggleLabel() {
  const btn = document.getElementById('add-days-toggle');
  const checked = Array.from(document.querySelectorAll('input[name="add-days"]:checked'))
    .map(el => parseInt(el.value))
    .filter(v => !Number.isNaN(v));
  if (!btn) return;
  if (checked.length === 0) {
    btn.textContent = `{{ _('–î–Ω–∏') }}: {{ _('–í—ã–±–µ—Ä–∏—Ç–µ') }}`;
  } else if (checked.length <= 3) {
    const names = checked.map(i => DAY_NAMES_SHORT[i]).join(', ');
    btn.textContent = `{{ _('–î–Ω–∏') }}: ${names}`;
  } else {
    btn.textContent = `{{ _('–î–Ω–∏') }}: ${checked.length} {{ _('–≤—ã–±—Ä–∞–Ω–æ') }}`;
  }
}

function initDaysSelection() {
  // preselect active day
  const el = document.querySelector(`input[name="add-days"][value="${activeDay}"]`);
  if (el) el.checked = true;
  // attach change listeners
  document.querySelectorAll('input[name="add-days"]').forEach(chk => {
    chk.addEventListener('change', updateDaysToggleLabel);
  });
  updateDaysToggleLabel();
}

// Add Form
document.getElementById('add-form').onsubmit = async (e) => {
  e.preventDefault();

  const time = document.getElementById('add-time').value.trim();
  const key = document.getElementById('add-group').value;
  const coach = document.getElementById('add-coach').value.trim() || null;

  if (!time || !key) return;

  const conf = GROUPS[key];
  if (!conf) return;

  // collect selected days; fallback to current activeDay if none
  const days = Array.from(document.querySelectorAll('input[name="add-days"]:checked'))
    .map(el => parseInt(el.value))
    .filter(v => !Number.isNaN(v));
  const targetDays = days.length > 0 ? days : [activeDay];

  try {
    const results = await Promise.allSettled(targetDays.map(day =>
      api('/admin/schedule/item', {
        method: 'POST',
        body: JSON.stringify({
        day_of_week: day,
        time,
        discipline: conf.discipline,
        age: conf.age,
        coach,
        ...(conf.discipline === 'other' ? { activity: conf.label } : {})
        }),
      })
    ));

    const ok = results.filter(r => r.status === 'fulfilled').length;
    await loadSchedule();
    resetAddForm();
    showToast(`${ok} {{ _('–¥–æ–±–∞–≤–ª–µ–Ω–æ') }}`);
  } catch (error) {
    showToast(error.message, 'error');
  }
};

// Toggle Add Panel
function toggleAddPanel() {
  document.getElementById('add-panel').classList.toggle('collapsed');
}

// Reset Add Form
function resetAddForm() {
  document.getElementById('add-form').reset();
  // restore default day selection to activeDay and update label
  document.querySelectorAll('input[name="add-days"]').forEach(chk => chk.checked = false);
  const el = document.querySelector(`input[name="add-days"][value="${activeDay}"]`);
  if (el) el.checked = true;
  updateDaysToggleLabel();
}



// Modal
function showModal(title, body, onConfirm) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').textContent = body;
  document.getElementById('modal-confirm').onclick = () => {
    closeModal();
    onConfirm();
  };
  document.getElementById('confirm-modal').classList.add('active');
}

function closeModal() {
  document.getElementById('confirm-modal').classList.remove('active');
}

// Dropdown
function toggleDropdown(event) {
  event.stopPropagation();
  const dropdown = event.target.closest('.dropdown');
  const wasActive = dropdown.classList.contains('active');
  
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
  
  if (!wasActive) {
    dropdown.classList.add('active');
  }
}

document.addEventListener('click', (event) => {
  // Don't close if clicking inside a dropdown
  if (!event.target.closest('.dropdown')) {
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
  }
});

// Setup Event Listeners
function setupEventListeners() {
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'a' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
      e.preventDefault();
      document.getElementById('add-time').focus();
    }
  });
}

// Override createScheduleCard to add checkbox
const originalCreateScheduleCard = createScheduleCard;
createScheduleCard = function(item) {
  const card = originalCreateScheduleCard(item);
  
  // Add checkbox
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.className = 'card-checkbox';
  checkbox.setAttribute('aria-label', `${item.time} ${item.activity}`);
  checkbox.onclick = (e) => {
    e.stopPropagation();
    if (window.toggleSelection) {
      window.toggleSelection(item.id, e);
    }
  };
  
  // Insert checkbox at the beginning
  card.insertBefore(checkbox, card.firstChild);
  
  // Make card clickable in selection mode
  card.onclick = (e) => {
    if (window.ScheduleMultiselect && window.ScheduleMultiselect.isSelectionMode() && 
        !e.target.closest('.card-actions') && !e.target.closest('.card-checkbox')) {
      if (window.toggleSelection) {
        window.toggleSelection(item.id, e);
      }
    }
  };
  
  return card;
};

// Override setActiveDay to reset selection
const originalSetActiveDay = setActiveDay;
setActiveDay = function(day) {
  originalSetActiveDay(day);
  if (window.ScheduleMultiselect) {
    window.ScheduleMultiselect.onDayChange();
  }
};

// Override loadSchedule to update multiselect state
const originalLoadSchedule = loadSchedule;
loadSchedule = async function() {
  await originalLoadSchedule();
  if (window.ScheduleMultiselect) {
    window.ScheduleMultiselect.updateState(scheduleData, activeDay);
    window.ScheduleMultiselect.updateSelectionUI();
  }
};

// Initialize on load
init();
</script>

<!-- Multiselect Module -->
<script src="{{ url_for('static', filename='js/schedule_multiselect.js') }}?v={{ range(1, 999999) | random }}"></script>
<script>
// Initialize multiselect module after main init
if (window.ScheduleMultiselect) {
  window.ScheduleMultiselect.init({
    api: api,
    showToast: showToast,
    loadSchedule: loadSchedule,
    closeModal: closeModal
  });
  window.ScheduleMultiselect.updateState(scheduleData, activeDay);
}
</script>
{% endblock %}
