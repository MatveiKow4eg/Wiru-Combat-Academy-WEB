{% extends "base.html" %}
{% block title %}{{ _('Редактор расписания') }}{% endblock %}
{% block extra_css %}
<style>
  :root {
    --accent: #e02525;
    --bg-primary: #0D0D0D;
    --bg-secondary: #121212;
    --surface: #1A1A1A;
    --surface-hover: #1F1F1F;
    --border: #2A2A2A;
    --text-primary: #EDEDED;
    --text-secondary: #9AA0A6;
    --success: #34A853;
    --danger: #EA4335;
    --warning: #FBBC04;
  }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
  }

  /* Page Layout */
  .schedule-editor {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 16px 40px;
  }

  /* Sticky Header */
  .editor-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--bg-primary);
    padding: 20px 0 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .editor-title {
    font-size: 32px;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  /* Days Tabs */
  .days-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    overflow-x: auto;
    scrollbar-width: thin;
  }

  .days-tabs::-webkit-scrollbar {
    height: 4px;
  }

  .days-tabs::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 2px;
  }

  .day-tab {
    position: relative;
    flex: 1;
    min-width: 120px;
    padding: 12px 16px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: center;
  }

  .day-tab:hover {
    background: var(--surface);
    border-color: var(--accent);
  }

  .day-tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .day-tab.today:not(.active)::before {
    content: '';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
  }

  .day-badge {
    display: inline-block;
    margin-left: 6px;
    padding: 2px 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    font-size: 11px;
    font-weight: 700;
  }

  /* Copy Day Bar */
  .copy-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .copy-bar-label {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
  }

  .copy-arrow {
    color: var(--text-secondary);
    font-size: 18px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover {
    background: #c91f1f;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(224, 37, 37, 0.3);
  }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-primary);
  }

  .btn-secondary:hover {
    background: var(--surface);
    border-color: var(--text-secondary);
  }

  .btn-danger {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
  }

  .btn-danger:hover {
    background: rgba(234, 67, 53, 0.1);
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 13px;
  }

  .btn-icon {
    padding: 8px;
    width: 36px;
    height: 36px;
  }

  /* Input Fields */
  .input {
    padding: 10px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.15s ease;
  }

  .input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(224, 37, 37, 0.1);
  }

  .input::placeholder {
    color: var(--text-secondary);
  }

  .input.error {
    border-color: var(--danger);
  }

  .input-error-text {
    display: block;
    margin-top: 4px;
    color: var(--danger);
    font-size: 12px;
  }

  .input-time {
    width: 100px;
    font-family: 'Courier New', monospace;
  }

  .input-age {
    width: 80px;
  }

  .age-range {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .age-separator {
    color: var(--text-secondary);
    font-weight: 600;
  }

  .input-coach {
    width: 100%;
  }

  /* Add Panel */
  .add-panel {
    margin-bottom: 24px;
    padding: 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
  }

  .add-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .add-panel-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .add-panel.collapsed .add-panel-body {
    display: none;
  }

  .add-form {
    display: grid;
    grid-template-columns: 100px 1fr 180px 1fr auto;
    gap: 12px;
    align-items: start;
  }

  .add-form-actions {
    display: flex;
    gap: 8px;
  }

  .form-hint {
    grid-column: 1 / -1;
    margin-top: -4px;
    color: var(--text-secondary);
    font-size: 12px;
  }

  /* Schedule List */
  .schedule-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Selection Mode Toolbar */
  .selection-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .selection-controls {
    display: none;
    align-items: center;
    gap: 12px;
  }

  .selection-toolbar.active .selection-controls {
    display: flex;
  }

  .btn-link {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    text-decoration: underline;
  }

  .btn-link:hover {
    color: var(--text-primary);
  }

  .schedule-card {
    display: grid;
    grid-template-columns: 24px 80px 1fr auto;
    gap: 16px;
    align-items: center;
    padding: 14px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    transition: all 0.15s ease;
    position: relative;
  }

  .schedule-card.editing {
    background: var(--surface-hover);
    border-color: var(--accent);
  }

  /* Selection Mode Styles */
  .schedule-card.selectable {
    cursor: pointer;
    user-select: none;
  }

  .schedule-card.selectable:hover {
    background: var(--surface-hover);
  }

  .schedule-card.selected {
    background: var(--surface-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(224, 37, 37, 0.2);
  }

  .schedule-card .card-checkbox {
    display: none;
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--accent);
  }

  .schedule-card.selectable .card-checkbox {
    display: block;
  }

  .schedule-card.selectable .drag-handle {
    display: none;
  }

  .schedule-card.selectable .card-actions {
    opacity: 0.3;
    pointer-events: none;
  }

  .drag-handle {
    color: var(--text-secondary);
    cursor: grab;
    font-size: 18px;
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .card-time {
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .card-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .card-meta {
    display: flex;
    gap: 12px;
    font-size: 13px;
    color: var(--text-secondary);
  }

  .card-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .card-actions {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  /* Edit Form in Card */
  .edit-form {
    grid-column: 2 / -1;
    display: grid;
    grid-template-columns: 100px 1fr 140px 180px auto;
    gap: 12px;
    align-items: start;
  }

  .edit-form-actions {
    display: flex;
    gap: 8px;
  }

  /* Empty State */
  .empty-state {
    padding: 60px 20px;
    text-align: center;
    color: var(--text-secondary);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
  }

  .empty-state-text {
    font-size: 14px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 480px;
    width: 100%;
  }

  .modal-header {
    margin-bottom: 16px;
  }

  .modal-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
  }

  .modal-body {
    margin-bottom: 24px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .modal-footer {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 14px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 200;
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .toast.success {
    border-color: var(--success);
  }

  .toast.error {
    border-color: var(--danger);
  }

  .toast-icon {
    font-size: 20px;
  }

  .toast.success .toast-icon {
    color: var(--success);
  }

  .toast.error .toast-icon {
    color: var(--danger);
  }

  .toast-message {
    flex: 1;
    font-size: 14px;
  }

  /* Dropdown Menu */
  .dropdown {
    position: relative;
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + 2px);
    right: 0;
    min-width: 160px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 150;
    padding: 4px;
  }

  /* Prevent gap between button and menu */
  .dropdown-menu::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 0;
    width: 100%;
    height: 6px;
  }

  .dropdown.active .dropdown-menu {
    display: block;
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    color: var(--text-primary);
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.1s ease;
  }

  .dropdown-item:hover {
    background: var(--surface-hover);
  }

  .dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
  }

  /* Responsive */
  @media (max-width: 1199px) {
    .add-form {
      grid-template-columns: 100px 1fr 140px auto;
    }
    
    .input-coach {
      grid-column: 1 / -1;
    }

    .edit-form {
      grid-template-columns: 100px 1fr 140px auto;
    }
  }

  @media (max-width: 767px) {
    .editor-title {
      font-size: 24px;
    }

    .day-tab {
      min-width: 100px;
      font-size: 13px;
      padding: 10px 12px;
    }

    .copy-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .add-form {
      grid-template-columns: 1fr;
    }

    .input-time,
    .input-age,
    .input-coach {
      width: 100%;
      min-width: 0;
    }

    .schedule-card {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .drag-handle {
      display: none;
    }

    .card-time {
      font-size: 14px;
    }

    .card-actions {
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .edit-form {
      grid-template-columns: 1fr;
    }
  }

  /* Loading State */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="schedule-editor">
  <!-- Sticky Header -->
  <div class="editor-header">
    <div class="header-top">
      <h1 class="editor-title">{{ _('Редактор расписания') }}</h1>
      <div class="header-actions">
        <a href="{{ url_for('schedule_page') }}" class="btn btn-secondary btn-sm">{{ _('Публичное расписание') }}</a>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary btn-sm">{{ _('Админ-панель') }}</a>
      </div>
    </div>

    <!-- Days Tabs -->
    <div class="days-tabs" id="days-tabs"></div>

    <!-- Copy Day Bar -->
    <div class="copy-bar">
      <span class="copy-bar-label">{{ _('Копировать день') }}:</span>
      <select id="copy-src" class="input" style="width: 160px;">
        <option value="" disabled selected>{{ _('Из') }}</option>
      </select>
      <span class="copy-arrow">→</span>
      <select id="copy-dst" class="input" style="width: 160px;">
        <option value="" disabled selected>{{ _('В') }}</option>
      </select>
      <button class="btn btn-primary btn-sm" id="copy-btn">{{ _('Скопировать') }}</button>
      <span id="copy-status" style="color: var(--text-secondary); font-size: 13px;"></span>
    </div>
  </div>

  <!-- Add Panel -->
  <div class="add-panel" id="add-panel">
    <div class="add-panel-header">
      <h3 class="add-panel-title">{{ _('Добавить занятие') }}</h3>
    </div>
    <div class="add-panel-body">
      <form class="add-form" id="add-form" onsubmit="return false;">
        <input type="time" class="input input-time" id="add-time" placeholder="00:00" required>
        <select class="input" id="add-discipline" required>
          <option value="" disabled selected>{{ _('Выберите активность') }}</option>
          <option value="boxing">{{ _('Бокс') }}</option>
          <option value="wrestling">{{ _('Борьба') }}</option>
          <option value="mma">{{ _('ММА') }}</option>
          <option value="other">{{ _('Другое') }}</option>
        </select>
        <input type="text" class="input" id="add-custom" placeholder="{{ _('Введите название') }}" style="display: none; grid-column: 2;">
        <div class="age-range">
          <input type="number" class="input input-age" id="add-age-from" placeholder="{{ _('От') }}" min="1" max="99">
          <span class="age-separator">–</span>
          <input type="number" class="input input-age" id="add-age-to" placeholder="{{ _('До') }}" min="1" max="99">
        </div>
        <input type="text" class="input input-coach" id="add-coach" placeholder="{{ _('Тренер (необязательно)') }}">
        <div class="add-form-actions">
          <button type="submit" class="btn btn-primary btn-sm">{{ _('Добавить') }}</button>
          <button type="button" class="btn btn-secondary btn-sm" onclick="resetAddForm()">{{ _('Очистить') }}</button>
        </div>
        <span class="form-hint">{{ _('Пример: Борьба 6–12, ММА 13+, Общая физиче��кая подготовка') }}</span>
      </form>
    </div>
  </div>

  <!-- Selection Toolbar -->
  <div class="selection-toolbar" id="selection-toolbar">
    <button class="btn btn-secondary btn-sm" id="select-mode-btn" onclick="toggleSelectionMode()" aria-pressed="false">
      {{ _('Выбрать') }}
    </button>
    <div class="selection-controls">
      <button 
        class="btn btn-danger btn-sm" 
        id="delete-selected-btn" 
        onclick="deleteSelected()" 
        disabled
        data-text-template="{{ _('Удалить') }}">
        {{ _('Удалить') }} (0)
      </button>
      <button 
        class="btn-link" 
        id="select-all-btn" 
        onclick="toggleSelectAll()"
        data-select-all-text="{{ _('Выбрать все') }}"
        data-deselect-all-text="{{ _('Снять всё') }}">
        {{ _('Выбрать все') }}
      </button>
    </div>
  </div>

  <!-- Schedule List -->
  <div id="schedule-list" class="schedule-list"></div>
</div>

<!-- Modals -->
<div class="modal" id="confirm-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">{{ _('Подтверждение') }}</h3>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">{{ _('Отмена') }}</button>
      <button class="btn btn-primary" id="modal-confirm">{{ _('Подтвердить') }}</button>
    </div>
  </div>
</div>

<script>
// CSRF Token
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return m ? decodeURIComponent(m[2]) : '';
}

const CSRF_TOKEN = (() => {
  const meta = document.querySelector('meta[name="csrf-token"]');
  if (meta?.content) return meta.content;
  const input = document.querySelector('input[name="csrf_token"]');
  if (input?.value) return input.value;
  return getCookie('csrf_token') || '';
})();

// Constants
const DAY_NAMES = [
  '{{ _('Понедельник') }}',
  '{{ _('Вторник') }}',
  '{{ _('Среда') }}',
  '{{ _('Четверг') }}',
  '{{ _('Пятница') }}',
  '{{ _('Суббота') }}',
  '{{ _('Воскресенье') }}'
];

const DAY_NAMES_SHORT = ['{{ _('Пн') }}', '{{ _('Вт') }}', '{{ _('Ср') }}', '{{ _('Чт') }}', '{{ _('Пт') }}', '{{ _('Сб') }}', '{{ _('Вс') }}'];

// Localized age suffix
const AGE_SUFFIX = '{{ _('age_suffix') }}';
const AGE_PREFIX_TO = '{{ _('до') }}';

// Debug: log the values
console.log('AGE_SUFFIX:', AGE_SUFFIX);
console.log('AGE_PREFIX_TO:', AGE_PREFIX_TO);

// State
let scheduleData = [];
let activeDay = (() => {
  const js = new Date().getDay();
  return js === 0 ? 6 : js - 1;
})();
const todayDay = activeDay;

// API Helper
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...opts.headers };
  if (CSRF_TOKEN) headers['X-CSRFToken'] = CSRF_TOKEN;
  
  const resp = await fetch(path, { ...opts, headers });
  const data = await resp.json().catch(() => ({}));
  
  if (!resp.ok) {
    throw new Error(data.error || `HTTP ${resp.status}`);
  }
  
  return data;
}

// Toast Notifications
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span class="toast-icon">${type === 'success' ? '✓' : '✕'}</span>
    <span class="toast-message">${message}</span>
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.2s ease reverse';
    setTimeout(() => toast.remove(), 200);
  }, 3000);
}

// Initialize
async function init() {
  renderDaysTabs();
  populateCopySelects();
  setupEventListeners();
  await loadSchedule();
}

// Render Days Tabs
function renderDaysTabs() {
  const container = document.getElementById('days-tabs');
  container.innerHTML = '';
  
  DAY_NAMES.forEach((name, index) => {
    const tab = document.createElement('button');
    tab.className = 'day-tab';
    tab.dataset.day = index;
    
    if (index === activeDay) tab.classList.add('active');
    if (index === todayDay) tab.classList.add('today');
    
    const count = scheduleData.filter(item => item.day_of_week === index).length;
    tab.innerHTML = `${DAY_NAMES_SHORT[index]}${index === activeDay && count > 0 ? `<span class="day-badge">${count}</span>` : ''}`;
    
    tab.onclick = () => setActiveDay(index);
    container.appendChild(tab);
  });
}

// Populate Copy Selects
function populateCopySelects() {
  const srcSelect = document.getElementById('copy-src');
  const dstSelect = document.getElementById('copy-dst');
  
  DAY_NAMES.forEach((name, index) => {
    srcSelect.innerHTML += `<option value="${index}">${name}</option>`;
    dstSelect.innerHTML += `<option value="${index}">${name}</option>`;
  });
}

// Set Active Day
function setActiveDay(day) {
  activeDay = day;
  renderDaysTabs();
  renderScheduleList();
}

// Load Schedule
async function loadSchedule() {
  try {
    scheduleData = await api('/admin/schedule/data');
    renderDaysTabs();
    renderScheduleList();
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// Render Schedule List
function renderScheduleList() {
  const container = document.getElementById('schedule-list');
  const dayItems = scheduleData
    .filter(item => item.day_of_week === activeDay)
    .sort((a, b) => a.time.localeCompare(b.time));
  
  if (dayItems.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">📅</div>
        <div class="empty-state-title">{{ _('Пока нет занятий') }}</div>
        <div class="empty-state-text">{{ _('Добавьте первое занятие для этого дня') }}</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  dayItems.forEach(item => {
    container.appendChild(createScheduleCard(item));
  });
}

// Create Schedule Card
function createScheduleCard(item) {
  const card = document.createElement('div');
  card.className = 'schedule-card';
  card.dataset.id = item.id;
  
  let activityDisplay;
  if (item.discipline === 'other') {
    activityDisplay = item.activity || '{{ _('Другое') }}';
  } else {
    const labels = {
      boxing: '{{ _('Бокс') }}',
      wrestling: '{{ _('Борьба') }}',
      mma: '{{ _('ММА') }}'
    };
    activityDisplay = labels[item.discipline] || item.activity;
    if (item.age) {
      // Remove old suffixes and add localized one
      const cleanedAge = item.age.replace(/[aлy][.,o]*/gi, '').trim();
      activityDisplay += ` ${cleanedAge}${AGE_SUFFIX}`;
    }
  }
  
  card.innerHTML = `
    <div class="drag-handle" title="{{ _('Перетащить') }}">⋮⋮</div>
    <div class="card-time">${item.time}</div>
    <div class="card-info">
      <div class="card-title">${activityDisplay}</div>
      ${item.coach ? `<div class="card-meta"><span class="card-meta-item">👤 ${item.coach}</span></div>` : ''}
    </div>
    <div class="card-actions">
      <button class="btn btn-secondary btn-sm" onclick="editItem(${item.id})">{{ _('Изменить') }}</button>
      <div class="dropdown">
        <button class="btn btn-secondary btn-icon btn-sm" onclick="toggleDropdown(event)">⋯</button>
        <div class="dropdown-menu">
          <div class="dropdown-item" onclick="moveItem(${item.id})">📤 {{ _('Перенести') }}</div>
          <div class="dropdown-item" onclick="duplicateItem(${item.id})">📋 {{ _('Дублировать') }}</div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" style="color: var(--danger);" onclick="deleteItem(${item.id})">🗑 {{ _('Удалить') }}</div>
        </div>
      </div>
    </div>
  `;
  
  return card;
}

// Edit Item
function editItem(id) {
  const item = scheduleData.find(i => i.id === id);
  if (!item) return;
  
  const card = document.querySelector(`[data-id="${id}"]`);
  card.classList.add('editing');
  
  // Extract custom name for 'other' discipline
  let customName = '';
  if (item.discipline === 'other' && item.activity) {
    customName = item.age && item.activity.endsWith(' ' + item.age) 
      ? item.activity.slice(0, -(item.age.length + 1))
      : item.activity;
  }
  
  // Parse age range
  const ageRange = parseAgeRange(item.age);
  
  card.innerHTML = `
    <div></div>
    <form class="edit-form" onsubmit="return saveEdit(event, ${id})">
      <input type="time" class="input input-time" value="${item.time}" required>
      <select class="input" id="edit-disc-${id}" required>
        <option value="boxing" ${item.discipline === 'boxing' ? 'selected' : ''}>{{ _('Бокс') }}</option>
        <option value="wrestling" ${item.discipline === 'wrestling' ? 'selected' : ''}>{{ _('Борьба') }}</option>
        <option value="mma" ${item.discipline === 'mma' ? 'selected' : ''}>{{ _('ММА') }}</option>
        <option value="other" ${item.discipline === 'other' ? 'selected' : ''}>{{ _('Другое') }}</option>
      </select>
      <input type="text" class="input" id="edit-custom-${id}" placeholder="{{ _('Введите название') }}" value="${customName}" style="display: ${item.discipline === 'other' ? 'block' : 'none'}; grid-column: 2;">
      <div class="age-range">
        <input type="number" class="input input-age" id="edit-age-from-${id}" placeholder="{{ _('От') }}" value="${ageRange.from}" min="1" max="99">
        <span class="age-separator">–</span>
        <input type="number" class="input input-age" id="edit-age-to-${id}" placeholder="{{ _('До') }}" value="${ageRange.to}" min="1" max="99">
      </div>
      <input type="text" class="input input-coach" value="${item.coach || ''}" placeholder="{{ _('Тренер') }}">
      <div class="edit-form-actions">
        <button type="submit" class="btn btn-primary btn-sm">{{ _('Сохранить') }}</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="loadSchedule()">{{ _('Отмена') }}</button>
      </div>
    </form>
  `;
  
  // Toggle custom input
  const discSelect = document.getElementById(`edit-disc-${id}`);
  const customInput = document.getElementById(`edit-custom-${id}`);
  discSelect.onchange = () => {
    customInput.style.display = discSelect.value === 'other' ? 'block' : 'none';
  };
}

// Save Edit
async function saveEdit(event, id) {
  event.preventDefault();
  const form = event.target;
  
  const ageFrom = document.getElementById(`edit-age-from-${id}`).value.trim();
  const ageTo = document.getElementById(`edit-age-to-${id}`).value.trim();
  const age = formatAgeRange(ageFrom, ageTo);
  
  const inputs = form.querySelectorAll('input, select');
  
  const payload = {
    time: inputs[0].value.trim(),
    discipline: inputs[1].value,
    age: age,
    coach: inputs[inputs.length - 2].value.trim() || null
  };
  
  if (payload.discipline === 'other') {
    const customInput = document.getElementById(`edit-custom-${id}`);
    payload.activity = customInput ? customInput.value.trim() : '';
  }
  
  try {
    await api(`/admin/schedule/item/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
    await loadSchedule();
    showToast('{{ _('Занятие обновлено') }}');
  } catch (error) {
    showToast(error.message, 'error');
  }
  
  return false;
}

// Delete Item
function deleteItem(id) {
  const item = scheduleData.find(i => i.id === id);
  if (!item) return;
  
  showModal(
    '{{ _('Удалить занятие?') }}',
    `{{ _('Вы уверены, что хотите удалить') }} "${item.activity}" {{ _('в') }} ${item.time}?`,
    async () => {
      try {
        await api(`/admin/schedule/item/${id}`, { method: 'DELETE' });
        await loadSchedule();
        showToast('{{ _('Занятие удалено') }}');
      } catch (error) {
        showToast(error.message, 'error');
      }
    }
  );
}

// Move Item
function moveItem(id) {
  // TODO: Implement move modal
  showToast('{{ _('Функция в разработке') }}', 'error');
}

// Duplicate Item
async function duplicateItem(id) {
  const item = scheduleData.find(i => i.id === id);
  if (!item) return;
  
  try {
    await api('/admin/schedule/item', {
      method: 'POST',
      body: JSON.stringify({
        day_of_week: activeDay,
        time: item.time,
        activity: item.activity,
        discipline: item.discipline,
        coach: item.coach,
        age: item.age
      })
    });
    await loadSchedule();
    showToast('{{ _('Занятие дублировано') }}');
  } catch (error) {
    showToast(error.message, 'error');
  }
}

// Helper function to format age range (WITHOUT suffix for storage)
function formatAgeRangeForStorage(from, to) {
  if (from && to) {
    return `${from}–${to}`;
  } else if (from) {
    return `${from}+`;
  } else if (to) {
    return `${AGE_PREFIX_TO} ${to}`;
  }
  return null;
}

// Helper function to format age range WITH suffix for display
function formatAgeRange(from, to) {
  if (from && to) {
    return `${from}–${to}${AGE_SUFFIX}`;
  } else if (from) {
    return `${from}+${AGE_SUFFIX}`;
  } else if (to) {
    return `${AGE_PREFIX_TO} ${to}${AGE_SUFFIX}`;
  }
  return null;
}

// Helper function to parse age range
function parseAgeRange(ageStr) {
  if (!ageStr) return { from: '', to: '' };
  
  // Remove "a.", "л.", "y." suffixes and trim
  const cleaned = ageStr.replace(/[aлy][.,]/g, '').trim();
  
  // Check for range (e.g., "6–12" or "6-12")
  const rangeMatch = cleaned.match(/^(\d+)\s*[–-]\s*(\d+)$/);
  if (rangeMatch) {
    return { from: rangeMatch[1], to: rangeMatch[2] };
  }
  
  // Check for "from+" (e.g., "13+")
  const plusMatch = cleaned.match(/^(\d+)\+$/);
  if (plusMatch) {
    return { from: plusMatch[1], to: '' };
  }
  
  // Check for "до X" / "kuni X" / "to X" (e.g., "до 12")
  const toMatch = cleaned.match(/^(?:до|kuni|to)\s+(\d+)$/i);
  if (toMatch) {
    return { from: '', to: toMatch[1] };
  }
  
  // Single number
  const singleMatch = cleaned.match(/^(\d+)$/);
  if (singleMatch) {
    return { from: singleMatch[1], to: singleMatch[1] };
  }
  
  return { from: '', to: '' };
}

// Add Form
document.getElementById('add-form').onsubmit = async (e) => {
  e.preventDefault();
  
  const time = document.getElementById('add-time').value.trim();
  const discipline = document.getElementById('add-discipline').value;
  const custom = document.getElementById('add-custom').value.trim();
  const ageFrom = document.getElementById('add-age-from').value.trim();
  const ageTo = document.getElementById('add-age-to').value.trim();
  const coach = document.getElementById('add-coach').value.trim() || null;
  
  if (!time || !discipline) return;
  
  const age = formatAgeRange(ageFrom, ageTo);
  
  const payload = {
    day_of_week: activeDay,
    time,
    discipline,
    age,
    coach
  };
  
  if (discipline === 'other') {
    payload.activity = custom;
  }
  
  try {
    await api('/admin/schedule/item', { method: 'POST', body: JSON.stringify(payload) });
    await loadSchedule();
    resetAddForm();
    showToast('{{ _('Занятие добавлено') }}');
  } catch (error) {
    showToast(error.message, 'error');
  }
};

// Toggle Add Panel
function toggleAddPanel() {
  document.getElementById('add-panel').classList.toggle('collapsed');
}

// Reset Add Form
function resetAddForm() {
  document.getElementById('add-form').reset();
  document.getElementById('add-custom').style.display = 'none';
}

// Add Discipline Change
document.getElementById('add-discipline').onchange = (e) => {
  const custom = document.getElementById('add-custom');
  custom.style.display = e.target.value === 'other' ? 'block' : 'none';
};

// Copy Day
document.getElementById('copy-btn').onclick = async () => {
  const src = parseInt(document.getElementById('copy-src').value);
  const dst = parseInt(document.getElementById('copy-dst').value);
  
  if (isNaN(src) || isNaN(dst) || src === dst) {
    showToast('{{ _('Выберите разные дни') }}', 'error');
    return;
  }
  
  showModal(
    '{{ _('Копировать день?') }}',
    `{{ _('Скопировать расписание из') }} ${DAY_NAMES[src]} {{ _('в') }} ${DAY_NAMES[dst]}. {{ _('Это добавит занятия') }}.`,
    async () => {
      try {
        const result = await api('/admin/schedule/copy_day', {
          method: 'POST',
          body: JSON.stringify({ source_day: src, target_day: dst, replace: false })
        });
        await loadSchedule();
        showToast(`{{ _('День скопирован') }}: ${DAY_NAMES[src]} → ${DAY_NAMES[dst]} (+${result.created})`);
      } catch (error) {
        showToast(error.message, 'error');
      }
    }
  );
};

// Modal
function showModal(title, body, onConfirm) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').textContent = body;
  document.getElementById('modal-confirm').onclick = () => {
    closeModal();
    onConfirm();
  };
  document.getElementById('confirm-modal').classList.add('active');
}

function closeModal() {
  document.getElementById('confirm-modal').classList.remove('active');
}

// Dropdown
function toggleDropdown(event) {
  event.stopPropagation();
  const dropdown = event.target.closest('.dropdown');
  const wasActive = dropdown.classList.contains('active');
  
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
  
  if (!wasActive) {
    dropdown.classList.add('active');
  }
}

document.addEventListener('click', (event) => {
  // Don't close if clicking inside a dropdown
  if (!event.target.closest('.dropdown')) {
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
  }
});

// Setup Event Listeners
function setupEventListeners() {
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'a' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
      e.preventDefault();
      document.getElementById('add-time').focus();
    }
  });
}

// Override createScheduleCard to add checkbox
const originalCreateScheduleCard = createScheduleCard;
createScheduleCard = function(item) {
  const card = originalCreateScheduleCard(item);
  
  // Add checkbox
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.className = 'card-checkbox';
  checkbox.setAttribute('aria-label', `${item.time} ${item.activity}`);
  checkbox.onclick = (e) => {
    e.stopPropagation();
    if (window.toggleSelection) {
      window.toggleSelection(item.id, e);
    }
  };
  
  // Insert checkbox at the beginning
  card.insertBefore(checkbox, card.firstChild);
  
  // Make card clickable in selection mode
  card.onclick = (e) => {
    if (window.ScheduleMultiselect && window.ScheduleMultiselect.isSelectionMode() && 
        !e.target.closest('.card-actions') && !e.target.closest('.card-checkbox')) {
      if (window.toggleSelection) {
        window.toggleSelection(item.id, e);
      }
    }
  };
  
  return card;
};

// Override setActiveDay to reset selection
const originalSetActiveDay = setActiveDay;
setActiveDay = function(day) {
  originalSetActiveDay(day);
  if (window.ScheduleMultiselect) {
    window.ScheduleMultiselect.onDayChange();
  }
};

// Override loadSchedule to update multiselect state
const originalLoadSchedule = loadSchedule;
loadSchedule = async function() {
  await originalLoadSchedule();
  if (window.ScheduleMultiselect) {
    window.ScheduleMultiselect.updateState(scheduleData, activeDay);
    window.ScheduleMultiselect.updateSelectionUI();
  }
};

// Initialize on load
init();
</script>

<!-- Multiselect Module -->
<script src="{{ url_for('static', filename='js/schedule_multiselect.js') }}?v={{ range(1, 999999) | random }}"></script>
<script>
// Initialize multiselect module after main init
if (window.ScheduleMultiselect) {
  window.ScheduleMultiselect.init({
    api: api,
    showToast: showToast,
    loadSchedule: loadSchedule,
    closeModal: closeModal
  });
  window.ScheduleMultiselect.updateState(scheduleData, activeDay);
}
</script>
{% endblock %}
